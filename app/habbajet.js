"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var checkbox_1 = require("./checkbox");
var _ = require("lodash");
var Moment = require("moment");
var HabbajetBinding = /** @class */ (function () {
    function HabbajetBinding(budget, saveObject, index, name, isNew, frames, value, factor, slack) {
        this.budget = budget;
        this.saveObject = saveObject;
        this.index = index;
        this.name = name;
        this.frames = frames;
        this.value = value;
        this.factor = factor;
        this.slack = slack;
        this.checkboxes = [
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 0),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 1),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 2),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 3),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 4),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 5),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 6)
        ];
        this.transforming = false;
        this.action = 'i';
        this.frame = 0;
        if (isNew) {
            this.state = 0;
            this.saveData();
        }
        else {
            this.value = saveObject.getString("h" + this.index + "value");
            this.name = saveObject.getString("h" + this.index + "name");
            this.state = saveObject.getNumber("h" + this.index + "stateIndex");
            this.factor = saveObject.getNumber("h" + this.index + "factor");
            this.slack = saveObject.getNumber("h" + this.index + "slack");
        }
        this.setState(this.state);
        this.setCheckboxTimes(isNew);
    }
    HabbajetBinding.prototype.dailyUpdate = function (success) {
        if (!this.activeDay.isSet()) {
            this.activeDay.fillCheckbox(success);
            this.checkboxStateUpdate();
            this.locked = true;
            this.saveData();
        }
    };
    HabbajetBinding.prototype.checkboxStateUpdate = function () {
        var newState = 0;
        _.forEach(this.checkboxes, function (c) {
            if (c.isChecked()) {
                newState++;
            }
        });
        if (this.activeDay.time === this.checkboxes[6].time) {
            this.endWeek(newState);
        }
        else {
            this.setState(newState);
        }
    };
    HabbajetBinding.prototype.setImage = function () {
        this.image = "~/images/h" + this.state + "/" + this.action + this.frame + ".png";
        // console.log("image changed to: " + this.image);
    };
    HabbajetBinding.prototype.animate = function () {
        if (this.frames.exists(this.state, this.frame, this.action)) {
            this.setImage();
        }
        else {
            this.makeIdle();
        }
        this.frame++;
    };
    HabbajetBinding.prototype.makeIdle = function () {
        this.resetBusiness();
        this.action = 'i';
        this.restartAnimation();
    };
    HabbajetBinding.prototype.restartAnimation = function () {
        var _this = this;
        clearInterval(this.animationID);
        this.frame = 0;
        this.animationID = setInterval(function () {
            _this.animate();
        }, 100);
    };
    HabbajetBinding.prototype.setState = function (newState) {
        var oldState = this.state;
        this.state = newState;
        if (newState !== oldState) {
            this.transform();
        }
        else {
            this.makeIdle();
        }
    };
    HabbajetBinding.prototype.endWeek = function (successes) {
        this.budget.updateTotal(successes, this.value, this.factor, this.slack);
        this.setState(0);
    };
    HabbajetBinding.prototype.saveData = function () {
        this.saveObject.setString("h" + this.index + "value", this.value);
        this.saveObject.setString("h" + this.index + "name", this.name);
        this.saveObject.setNumber("h" + this.index + "stateIndex", this.state);
        this.saveObject.setNumber("h" + this.index + "factor", this.factor);
        this.saveObject.setNumber("h" + this.index + "slack", this.slack);
    };
    HabbajetBinding.prototype.transform = function () {
        this.transforming = true;
        this.action = 't';
        this.restartAnimation();
    };
    HabbajetBinding.prototype.act = function () {
        if (this.isBusy()) {
            return;
        }
        this.transforming = false;
        var actionType = Math.random() * 2;
        if (actionType < 1 && this.frames.exists(this.state, 0, 'a')) {
            this.action = 'a';
        }
        else if (this.frames.exists(this.state, 0, 'b')) {
            this.action = 'b';
        }
        this.restartAnimation();
    };
    HabbajetBinding.prototype.resetBusiness = function () {
        this.transforming = false;
    };
    HabbajetBinding.prototype.isBusy = function () {
        return this.transforming;
    };
    HabbajetBinding.prototype.update = function (newName, newValue) {
        this.name = newName;
        this.value = newValue;
    };
    HabbajetBinding.prototype.updateIndex = function (newIndex) {
        this.deleteData();
        this.index = newIndex;
        this.saveData();
        this.changeCheckboxIndices();
    };
    HabbajetBinding.prototype.deleteData = function () {
        this.saveObject.remove("h" + this.index + "value");
        this.saveObject.remove("h" + this.index + "name");
        this.saveObject.remove("h" + this.index + "stateIndex");
        this.saveObject.remove("h" + this.index + "factor");
        this.saveObject.remove("h" + this.index + "slack");
    };
    HabbajetBinding.prototype.setCheckboxTimes = function (isNew) {
        var today = Moment().startOf('week').subtract(1, 'days');
        if (!isNew && this.checkboxes[6].time < today.valueOf()) {
            if (!this.checkboxes[6].isSet()) {
                var numChecked_1 = 0;
                _.forEach(this.checkboxes, function (c) {
                    if (c.isChecked()) {
                        numChecked_1++;
                    }
                });
                this.state = 0;
                this.endWeek(numChecked_1);
            }
            _.forEach(this.checkboxes, function (c) {
                c.reset();
            });
        }
        for (var i = 0; i < 7; i++) {
            this.checkboxes[i].setTime(today.add(1, 'days').format('dddd Do MMM'), today.valueOf());
            if (this.checkboxes[i].time < Moment().endOf('day').valueOf()) {
                this.activeDay = this.checkboxes[i];
            }
        }
        this.locked = this.activeDay.isSet();
    };
    HabbajetBinding.prototype.changeCheckboxIndices = function () {
        for (var i = 0; i < 7; i++) {
            this.checkboxes[i].changeIndex(this.index);
        }
    };
    HabbajetBinding.prototype.updateTabText = function (maxChars) {
        if (this.name.length > maxChars) {
            this.tabName = this.name.substring(0, maxChars);
        }
        else {
            this.tabName = this.name;
        }
    };
    HabbajetBinding.prototype.switchDay = function (index) {
        this.activeDay = this.checkboxes[index];
        this.locked = this.activeDay.isSet() || this.checkboxes[6].isSet();
    };
    return HabbajetBinding;
}());
exports.HabbajetBinding = HabbajetBinding;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFiYmFqZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJoYWJiYWpldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUE2QztBQUM3QywwQkFBNEI7QUFJNUIsK0JBQWlDO0FBRWpDO0lBY0UseUJBQW9CLE1BQXFCLEVBQVUsVUFBZSxFQUN0RCxLQUFhLEVBQVMsSUFBWSxFQUFFLEtBQWMsRUFDbEQsTUFBbUIsRUFBUyxLQUFhLEVBQVUsTUFBYyxFQUFVLEtBQWE7UUFGaEYsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUFVLGVBQVUsR0FBVixVQUFVLENBQUs7UUFDdEQsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUFTLFNBQUksR0FBSixJQUFJLENBQVE7UUFDbEMsV0FBTSxHQUFOLE1BQU0sQ0FBYTtRQUFTLFVBQUssR0FBTCxLQUFLLENBQVE7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUVsRyxJQUFJLENBQUMsVUFBVSxHQUFHO1lBQ2hCLElBQUksMEJBQWUsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDaEQsSUFBSSwwQkFBZSxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNoRCxJQUFJLDBCQUFlLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ2hELElBQUksMEJBQWUsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDaEQsSUFBSSwwQkFBZSxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNoRCxJQUFJLDBCQUFlLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ2hELElBQUksMEJBQWUsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxD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QUM7SUFDSCxDQUFDO0lBRUQsdUNBQWEsR0FBYixVQUFjLFFBQVc7UUFDdkIsRUFBRSxDQUFBLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUMvQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNsRCxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDM0IsQ0FBQztJQUNILENBQUM7SUFFRCxtQ0FBUyxHQUFULFVBQVUsS0FBYTtRQUNyQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDckUsQ0FBQztJQUNILHNCQUFDO0FBQUQsQ0FBQyxBQXJORCxJQXFOQztBQXJOWSwwQ0FBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoZWNrYm94QmluZGluZyB9IGZyb20gXCIuL2NoZWNrYm94XCI7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0ICogYXMgRGlhbG9ncyBmcm9tICd1aS9kaWFsb2dzJztcclxuaW1wb3J0IHsgQnVkZ2V0QmluZGluZyB9IGZyb20gXCIuL2J1ZGdldFwiO1xyXG5pbXBvcnQgeyBGcmFtZUNvdW50cyB9IGZyb20gXCIuL2ZyYW1lLWNvdW50c1wiO1xyXG5pbXBvcnQgKiBhcyBNb21lbnQgZnJvbSBcIm1vbWVudFwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIEhhYmJhamV0QmluZGluZyB7XHJcbiAgcHJpdmF0ZSBzdGF0ZTogbnVtYmVyO1xyXG4gIHByaXZhdGUgZnJhbWU6IG51bWJlcjtcclxuICBwcml2YXRlIGFjdGlvbjogc3RyaW5nO1xyXG4gIHB1YmxpYyBpbWFnZTogc3RyaW5nO1xyXG4gIHB1YmxpYyBjaGVja2JveGVzOiBDaGVja2JveEJpbmRpbmdbXTtcclxuICBwdWJsaWMgYWN0aXZlRGF5OiBDaGVja2JveEJpbmRpbmc7XHJcbiAgcHVibGljIGFuaW1hdGluZzogYm9vbGVhbjtcclxuICBwdWJsaWMgYW5pbWF0aW9uSUQ6IG51bWJlcjtcclxuICBwdWJsaWMgdGFiTmFtZTogc3RyaW5nO1xyXG5cclxuICBwdWJsaWMgdHJhbnNmb3JtaW5nOiBib29sZWFuO1xyXG4gIHB1YmxpYyBsb2NrZWQ6IGJvb2xlYW47XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYnVkZ2V0OiBCdWRnZXRCaW5kaW5nLCBwcml2YXRlIHNhdmVPYmplY3Q6IGFueSxcclxuICAgICAgcHJpdmF0ZSBpbmRleDogbnVtYmVyLCBwdWJsaWMgbmFtZTogc3RyaW5nLCBpc05ldzogYm9vbGVhbixcclxuICAgICAgcHJpdmF0ZSBmcmFtZXM6IEZyYW1lQ291bnRzLCBwdWJsaWMgdmFsdWU6IHN0cmluZywgcHJpdmF0ZSBmYWN0b3I6IG51bWJlciwgcHJpdmF0ZSBzbGFjazogbnVtYmVyKSB7XHJcbiAgICBcclxuICAgIHRoaXMuY2hlY2tib3hlcyA9IFtcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhzYXZlT2JqZWN0LCBpbmRleCwgaXNOZXcsIDApLFxyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKHNhdmVPYmplY3QsIGluZGV4LCBpc05ldywgMSksXHJcbiAgICAgIG5ldyBDaGVja2JveEJpbmRpbmcoc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3LCAyKSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhzYXZlT2JqZWN0LCBpbmRleCwgaXNOZXcsIDMpLFxyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKHNhdmVPYmplY3QsIGluZGV4LCBpc05ldywgNCksXHJcbiAgICAgIG5ldyBDaGVja2JveEJpbmRpbmcoc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3LCA1KSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhzYXZlT2JqZWN0LCBpbmRleCwgaXNOZXcsIDYpXHJcbiAgICBdO1xyXG4gICAgXHJcbiAgICB0aGlzLiB0cmFuc2Zvcm1pbmcgPSBmYWxzZTtcclxuICAgIHRoaXMuYWN0aW9uID0gJ2knO1xyXG4gICAgdGhpcy5mcmFtZSA9IDA7XHJcbiAgICBpZihpc05ldykge1xyXG4gICAgICB0aGlzLnN0YXRlID0gMDtcclxuICAgICAgdGhpcy5zYXZlRGF0YSgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy52YWx1ZSA9IHNhdmVPYmplY3QuZ2V0U3RyaW5nKFwiaFwiICsgdGhpcy5pbmRleCArIFwidmFsdWVcIilcclxuICAgICAgdGhpcy5uYW1lID0gc2F2ZU9iamVjdC5nZXRTdHJpbmcoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJuYW1lXCIpO1xyXG4gICAgICB0aGlzLnN0YXRlID0gc2F2ZU9iamVjdC5nZXROdW1iZXIoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJzdGF0ZUluZGV4XCIpO1xyXG4gICAgICB0aGlzLmZhY3RvciA9IHNhdmVPYmplY3QuZ2V0TnVtYmVyKFwiaFwiICsgdGhpcy5pbmRleCArIFwiZmFjdG9yXCIpO1xyXG4gICAgICB0aGlzLnNsYWNrID0gc2F2ZU9iamVjdC5nZXROdW1iZXIoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJzbGFja1wiKTtcclxuICAgIH1cclxuICAgIHRoaXMuc2V0U3RhdGUodGhpcy5zdGF0ZSk7XHJcbiAgICB0aGlzLnNldENoZWNrYm94VGltZXMoaXNOZXcpO1xyXG4gIH1cclxuXHJcbiAgZGFpbHlVcGRhdGUoc3VjY2VzczogYm9vbGVhbikge1xyXG4gICAgaWYoIXRoaXMuYWN0aXZlRGF5LmlzU2V0KCkpIHtcclxuICAgICAgdGhpcy5hY3RpdmVEYXkuZmlsbENoZWNrYm94KHN1Y2Nlc3MpO1xyXG4gICAgICB0aGlzLmNoZWNrYm94U3RhdGVVcGRhdGUoKTtcclxuICAgICAgdGhpcy5sb2NrZWQgPSB0cnVlO1xyXG4gICAgICB0aGlzLnNhdmVEYXRhKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjaGVja2JveFN0YXRlVXBkYXRlKCkge1xyXG4gICAgbGV0IG5ld1N0YXRlID0gMDtcclxuICAgIF8uZm9yRWFjaCh0aGlzLmNoZWNrYm94ZXMsIChjKSA9PiB7XHJcbiAgICAgIGlmKGMuaXNDaGVja2VkKCkpIHtcclxuICAgICAgICBuZXdTdGF0ZSsrO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZih0aGlzLmFjdGl2ZURheS50aW1lID09PSB0aGlzLmNoZWNrYm94ZXNbNl0udGltZSkge1xyXG4gICAgICB0aGlzLmVuZFdlZWsobmV3U3RhdGUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5zZXRTdGF0ZShuZXdTdGF0ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZXRJbWFnZSgpIHtcclxuICAgIHRoaXMuaW1hZ2UgPSBcIn4vaW1hZ2VzL2hcIiArIHRoaXMuc3RhdGUgKyBcIi9cIiArIHRoaXMuYWN0aW9uICsgdGhpcy5mcmFtZSArIFwiLnBuZ1wiO1xyXG4gICAgLy8gY29uc29sZS5sb2coXCJpbWFnZSBjaGFuZ2VkIHRvOiBcIiArIHRoaXMuaW1hZ2UpO1xyXG4gIH1cclxuXHJcbiAgYW5pbWF0ZSgpIHtcclxuICAgICAgaWYodGhpcy5mcmFtZXMuZXhpc3RzKHRoaXMuc3RhdGUsIHRoaXMuZnJhbWUsIHRoaXMuYWN0aW9uKSkge1xyXG4gICAgICAgIHRoaXMuc2V0SW1hZ2UoKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLm1ha2VJZGxlKCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5mcmFtZSsrO1xyXG4gIH1cclxuXHJcbiAgbWFrZUlkbGUoKSB7XHJcbiAgICB0aGlzLnJlc2V0QnVzaW5lc3MoKTtcclxuICAgIHRoaXMuYWN0aW9uID0gJ2knO1xyXG4gICAgdGhpcy5yZXN0YXJ0QW5pbWF0aW9uKCk7XHJcbiAgfVxyXG5cclxuICByZXN0YXJ0QW5pbWF0aW9uKCkge1xyXG4gICAgY2xlYXJJbnRlcnZhbCh0aGlzLmFuaW1hdGlvbklEKTtcclxuICAgIHRoaXMuZnJhbWUgPSAwO1xyXG4gICAgdGhpcy5hbmltYXRpb25JRCA9IHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgdGhpcy5hbmltYXRlKCk7XHJcbiAgICB9LCAxMDApO1xyXG4gIH1cclxuXHJcbiAgc2V0U3RhdGUobmV3U3RhdGU6IG51bWJlcikge1xyXG4gICAgY29uc3Qgb2xkU3RhdGUgPSB0aGlzLnN0YXRlO1xyXG4gICAgdGhpcy5zdGF0ZSA9IG5ld1N0YXRlO1xyXG4gICAgaWYobmV3U3RhdGUgIT09IG9sZFN0YXRlKSB7XHJcbiAgICAgIHRoaXMudHJhbnNmb3JtKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLm1ha2VJZGxlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBlbmRXZWVrKHN1Y2Nlc3NlczogbnVtYmVyKSB7XHJcbiAgICB0aGlzLmJ1ZGdldC51cGRhdGVUb3RhbChzdWNjZXNzZXMsIHRoaXMudmFsdWUsIHRoaXMuZmFjdG9yLCB0aGlzLnNsYWNrKTtcclxuICAgIHRoaXMuc2V0U3RhdGUoMCk7XHJcbiAgfVxyXG5cclxuICBzYXZlRGF0YSgpIHtcclxuICAgIHRoaXMuc2F2ZU9iamVjdC5zZXRTdHJpbmcoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJ2YWx1ZVwiLCB0aGlzLnZhbHVlKTtcclxuICAgIHRoaXMuc2F2ZU9iamVjdC5zZXRTdHJpbmcoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJuYW1lXCIsIHRoaXMubmFtZSk7XHJcbiAgICB0aGlzLnNhdmVPYmplY3Quc2V0TnVtYmVyKFwiaFwiICsgdGhpcy5pbmRleCArIFwic3RhdGVJbmRleFwiLCB0aGlzLnN0YXRlKTtcclxuICAgIHRoaXMuc2F2ZU9iamVjdC5zZXROdW1iZXIoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJmYWN0b3JcIiwgdGhpcy5mYWN0b3IpO1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnNldE51bWJlcihcImhcIiArIHRoaXMuaW5kZXggKyBcInNsYWNrXCIsIHRoaXMuc2xhY2spO1xyXG4gIH1cclxuXHJcbiAgdHJhbnNmb3JtKCkge1xyXG4gICAgdGhpcy50cmFuc2Zvcm1pbmcgPSB0cnVlO1xyXG4gICAgdGhpcy5hY3Rpb24gPSAndCc7XHJcbiAgICB0aGlzLnJlc3RhcnRBbmltYXRpb24oKTtcclxuICB9XHJcblxyXG4gIGFjdCgpIHtcclxuICAgIGlmICh0aGlzLmlzQnVzeSgpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMudHJhbnNmb3JtaW5nID0gZmFsc2U7XHJcbiAgICBjb25zdCBhY3Rpb25UeXBlID0gTWF0aC5yYW5kb20oKSAqIDJcclxuICAgIGlmKGFjdGlvblR5cGUgPCAxICYmIHRoaXMuZnJhbWVzLmV4aXN0cyh0aGlzLnN0YXRlLCAwLCAnYScpKSB7XHJcbiAgICAgIHRoaXMuYWN0aW9uID0gJ2EnO1xyXG4gICAgfSBlbHNlIGlmKHRoaXMuZnJhbWVzLmV4aXN0cyh0aGlzLnN0YXRlLCAwLCAnYicpKSB7XHJcbiAgICAgIHRoaXMuYWN0aW9uID0gJ2InO1xyXG4gICAgfVxyXG4gICAgdGhpcy5yZXN0YXJ0QW5pbWF0aW9uKCk7XHJcbiAgfVxyXG5cclxuICByZXNldEJ1c2luZXNzKCkge1xyXG4gICAgdGhpcy50cmFuc2Zvcm1pbmcgPSBmYWxzZTtcclxuICB9XHJcblxyXG4gIGlzQnVzeSgpIHtcclxuICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybWluZztcclxuICB9XHJcblxyXG4gIHVwZGF0ZShuZXdOYW1lOiBzdHJpbmcsIG5ld1ZhbHVlOiBzdHJpbmcpIHtcclxuICAgIHRoaXMubmFtZSA9IG5ld05hbWU7XHJcbiAgICB0aGlzLnZhbHVlID0gbmV3VmFsdWU7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVJbmRleChuZXdJbmRleDogbnVtYmVyKSB7XHJcbiAgICB0aGlzLmRlbGV0ZURhdGEoKTtcclxuICAgIHRoaXMuaW5kZXggPSBuZXdJbmRleDtcclxuICAgIHRoaXMuc2F2ZURhdGEoKTtcclxuICAgIHRoaXMuY2hhbmdlQ2hlY2tib3hJbmRpY2VzKCk7XHJcbiAgfVxyXG5cclxuICBkZWxldGVEYXRhKCkge1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnJlbW92ZShcImhcIiArIHRoaXMuaW5kZXggKyBcInZhbHVlXCIpO1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnJlbW92ZShcImhcIiArIHRoaXMuaW5kZXggKyBcIm5hbWVcIik7XHJcbiAgICB0aGlzLnNhdmVPYmplY3QucmVtb3ZlKFwiaFwiICsgdGhpcy5pbmRleCArIFwic3RhdGVJbmRleFwiKTtcclxuICAgIHRoaXMuc2F2ZU9iamVjdC5yZW1vdmUoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJmYWN0b3JcIik7XHJcbiAgICB0aGlzLnNhdmVPYmplY3QucmVtb3ZlKFwiaFwiICsgdGhpcy5pbmRleCArIFwic2xhY2tcIik7XHJcbiAgfVxyXG5cclxuICBzZXRDaGVja2JveFRpbWVzKGlzTmV3OiBib29sZWFuKSB7XHJcbiAgICBsZXQgdG9kYXkgPSBNb21lbnQoKS5zdGFydE9mKCd3ZWVrJykuc3VidHJhY3QoMSwgJ2RheXMnKTtcclxuICAgIGlmKCFpc05ldyAmJiAgdGhpcy5jaGVja2JveGVzWzZdLnRpbWUgPCB0b2RheS52YWx1ZU9mKCkpIHtcclxuICAgICAgaWYoIXRoaXMuY2hlY2tib3hlc1s2XS5pc1NldCgpKSB7XHJcbiAgICAgICAgbGV0IG51bUNoZWNrZWQgPSAwO1xyXG4gICAgICAgIF8uZm9yRWFjaCh0aGlzLmNoZWNrYm94ZXMsIChjKSA9PiB7XHJcbiAgICAgICAgICBpZihjLmlzQ2hlY2tlZCgpKSB7XHJcbiAgICAgICAgICAgIG51bUNoZWNrZWQrKztcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnN0YXRlID0gMDtcclxuICAgICAgICB0aGlzLmVuZFdlZWsobnVtQ2hlY2tlZCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIF8uZm9yRWFjaCh0aGlzLmNoZWNrYm94ZXMsIChjKSA9PiB7XHJcbiAgICAgICAgYy5yZXNldCgpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNzsgaSsrKSB7XHJcbiAgICAgIHRoaXMuY2hlY2tib3hlc1tpXS5zZXRUaW1lKHRvZGF5LmFkZCgxLCAnZGF5cycpLmZvcm1hdCgnZGRkZCBEbyBNTU0nKSwgdG9kYXkudmFsdWVPZigpKTtcclxuICAgICAgaWYodGhpcy5jaGVja2JveGVzW2ldLnRpbWUgPCBNb21lbnQoKS5lbmRPZignZGF5JykudmFsdWVPZigpKSB7XHJcbiAgICAgICAgdGhpcy5hY3RpdmVEYXkgPSB0aGlzLmNoZWNrYm94ZXNbaV07XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMubG9ja2VkID0gdGhpcy5hY3RpdmVEYXkuaXNTZXQoKTtcclxuICB9XHJcblxyXG4gIGNoYW5nZUNoZWNrYm94SW5kaWNlcygpIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNzsgaSsrKSB7XHJcbiAgICAgIHRoaXMuY2hlY2tib3hlc1tpXS5jaGFuZ2VJbmRleCh0aGlzLmluZGV4KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHVwZGF0ZVRhYlRleHQobWF4Q2hhcnM6IDApIHtcclxuICAgIGlmKHRoaXMubmFtZS5sZW5ndGggPiBtYXhDaGFycykge1xyXG4gICAgICB0aGlzLnRhYk5hbWUgPSB0aGlzLm5hbWUuc3Vic3RyaW5nKDAsIG1heENoYXJzKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMudGFiTmFtZSA9IHRoaXMubmFtZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHN3aXRjaERheShpbmRleDogbnVtYmVyKSB7XHJcbiAgICB0aGlzLmFjdGl2ZURheSA9IHRoaXMuY2hlY2tib3hlc1tpbmRleF07XHJcbiAgICB0aGlzLmxvY2tlZCA9IHRoaXMuYWN0aXZlRGF5LmlzU2V0KCkgfHwgdGhpcy5jaGVja2JveGVzWzZdLmlzU2V0KCk7XHJcbiAgfVxyXG59Il19