"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var checkbox_1 = require("./checkbox");
var _ = require("lodash");
var Moment = require("moment");
var HabbajetBinding = /** @class */ (function () {
    function HabbajetBinding(budget, saveObject, index, name, isNew, frames, value) {
        this.budget = budget;
        this.saveObject = saveObject;
        this.index = index;
        this.name = name;
        this.frames = frames;
        this.value = value;
        this.checkboxes = [
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 0),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 1),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 2),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 3),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 4),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 5),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 6)
        ];
        this.transforming = false;
        this.action = 'i';
        this.frame = 0;
        if (isNew) {
            this.state = 0;
            this.saveData();
        }
        else {
            this.value = saveObject.getString("h" + this.index + "value");
            this.name = saveObject.getString("h" + this.index + "name");
            this.state = saveObject.getNumber("h" + this.index + "stateIndex");
        }
        this.setState(this.state);
        this.setCheckboxTimes(isNew);
    }
    HabbajetBinding.prototype.dailyUpdate = function (success) {
        if (!this.activeDay.isSet()) {
            this.activeDay.fillCheckbox(success);
            this.checkboxStateUpdate();
            this.locked = true;
            this.saveData();
        }
    };
    HabbajetBinding.prototype.checkboxStateUpdate = function () {
        var newState = 0;
        _.forEach(this.checkboxes, function (c) {
            if (c.isChecked()) {
                newState++;
            }
        });
        if (this.activeDay.time === this.checkboxes[6].time) {
            this.endWeek(newState);
        }
        else {
            this.setState(newState);
        }
    };
    HabbajetBinding.prototype.setImage = function () {
        this.image = "~/images/h" + this.state + "/" + this.action + this.frame + ".png";
        // console.log("image changed to: " + this.image);
    };
    HabbajetBinding.prototype.animate = function () {
        if (this.frames.exists(this.state, this.frame, this.action)) {
            this.setImage();
        }
        else {
            this.makeIdle();
        }
        this.frame++;
    };
    HabbajetBinding.prototype.makeIdle = function () {
        this.resetBusiness();
        this.action = 'i';
        this.restartAnimation();
    };
    HabbajetBinding.prototype.restartAnimation = function () {
        var _this = this;
        clearInterval(this.animationID);
        this.frame = 0;
        this.animationID = setInterval(function () {
            _this.animate();
        }, 100);
    };
    HabbajetBinding.prototype.setState = function (newState) {
        var oldState = this.state;
        this.state = newState;
        if (newState !== oldState) {
            this.transform();
        }
        else {
            this.makeIdle();
        }
    };
    HabbajetBinding.prototype.endWeek = function (successes) {
        this.budget.updateTotal(successes, this.value);
        this.setState(0);
    };
    HabbajetBinding.prototype.saveData = function () {
        this.saveObject.setString("h" + this.index + "value", this.value);
        this.saveObject.setString("h" + this.index + "name", this.name);
        this.saveObject.setNumber("h" + this.index + "stateIndex", this.state);
    };
    HabbajetBinding.prototype.transform = function () {
        this.transforming = true;
        this.action = 't';
        this.restartAnimation();
    };
    HabbajetBinding.prototype.act = function () {
        if (this.isBusy()) {
            return;
        }
        this.transforming = false;
        var actionType = Math.random() * 2;
        if (actionType < 1 && this.frames.exists(this.state, 0, 'a')) {
            this.action = 'a';
        }
        else if (this.frames.exists(this.state, 0, 'b')) {
            this.action = 'b';
        }
        this.restartAnimation();
    };
    HabbajetBinding.prototype.resetBusiness = function () {
        this.transforming = false;
    };
    HabbajetBinding.prototype.isBusy = function () {
        return this.transforming;
    };
    HabbajetBinding.prototype.update = function (newName, newValue) {
        this.name = newName;
        this.value = newValue;
    };
    HabbajetBinding.prototype.updateIndex = function (newIndex) {
        this.deleteData();
        this.index = newIndex;
        this.saveData();
        this.changeCheckboxIndices();
    };
    HabbajetBinding.prototype.deleteData = function () {
        this.saveObject.remove("h" + this.index + "value");
        this.saveObject.remove("h" + this.index + "name");
        this.saveObject.remove("h" + this.index + "stateIndex");
    };
    HabbajetBinding.prototype.setCheckboxTimes = function (isNew) {
        var today = Moment().startOf('week').subtract(1, 'days');
        if (!isNew && this.checkboxes[6].time < today.valueOf()) {
            if (!this.checkboxes[6].isSet()) {
                var numChecked_1 = 0;
                _.forEach(this.checkboxes, function (c) {
                    if (c.isChecked()) {
                        numChecked_1++;
                    }
                });
                this.state = 0;
                this.endWeek(numChecked_1);
            }
            _.forEach(this.checkboxes, function (c) {
                c.reset();
            });
        }
        for (var i = 0; i < 7; i++) {
            this.checkboxes[i].setTime(today.add(1, 'days').format('dddd Do MMM'), today.valueOf());
            if (this.checkboxes[i].time < Moment().endOf('day').valueOf()) {
                this.activeDay = this.checkboxes[i];
            }
        }
        this.locked = this.activeDay.isSet();
    };
    HabbajetBinding.prototype.changeCheckboxIndices = function () {
        for (var i = 0; i < 7; i++) {
            this.checkboxes[i].changeIndex(this.index);
        }
    };
    return HabbajetBinding;
}());
exports.HabbajetBinding = HabbajetBinding;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFiYmFqZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJoYWJiYWpldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUE2QztBQUM3QywwQkFBNEI7QUFJNUIsK0JBQWlDO0FBRWpDO0lBYUUseUJBQW9CLE1BQXFCLEVBQVUsVUFBZSxFQUN0RCxLQUFhLEVBQVMsSUFBWSxFQUFFLEtBQWMsRUFDbEQsTUFBbUIsRUFBUyxLQUFhO1FBRmpDLFdBQU0sR0FBTixNQUFNLENBQWU7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFLO1FBQ3RELFVBQUssR0FBTCxLQUFLLENBQVE7UUFBUyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQWE7UUFBUyxVQUFLLEdBQUwsS0FBSyxDQUFRO1FBRW5ELElBQUksQ0FBQyxVQUFVLEdBQUc7WUFDaEIsSUFBSSwwQkFBZSxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNoRCxJQUFJLDBCQUFlLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ2hELElBQUksMEJBQWUsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDaEQsSUFBSSwwQkFBZSxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNoRCxJQUFJLDBCQUFlLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ2hELElBQUksMEJBQWUsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDaEQsSUFBSSwwQkFBZSxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUNqRCxDQUFDO1FBRUYsSUFBSSxDQUFFLFlBQVksR0FBRyxLQUFLLENBQUM7UUFDM0IsSUFBSSxDQUFD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LE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3ZDLENBQUM7SUFFRCwrQ0FBcUIsR0FBckI7UUFDRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQzNCLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QyxDQUFDO0lBQ0gsQ0FBQztJQUNILHNCQUFDO0FBQUQsQ0FBQyxBQWpNRCxJQWlNQztBQWpNWSwwQ0FBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoZWNrYm94QmluZGluZyB9IGZyb20gXCIuL2NoZWNrYm94XCI7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0ICogYXMgRGlhbG9ncyBmcm9tICd1aS9kaWFsb2dzJztcclxuaW1wb3J0IHsgQnVkZ2V0QmluZGluZyB9IGZyb20gXCIuL2J1ZGdldFwiO1xyXG5pbXBvcnQgeyBGcmFtZUNvdW50cyB9IGZyb20gXCIuL2ZyYW1lLWNvdW50c1wiO1xyXG5pbXBvcnQgKiBhcyBNb21lbnQgZnJvbSBcIm1vbWVudFwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIEhhYmJhamV0QmluZGluZyB7XHJcbiAgcHJpdmF0ZSBzdGF0ZTogbnVtYmVyO1xyXG4gIHByaXZhdGUgZnJhbWU6IG51bWJlcjtcclxuICBwcml2YXRlIGFjdGlvbjogc3RyaW5nO1xyXG4gIHB1YmxpYyBpbWFnZTogc3RyaW5nO1xyXG4gIHB1YmxpYyBjaGVja2JveGVzOiBDaGVja2JveEJpbmRpbmdbXTtcclxuICBwdWJsaWMgYWN0aXZlRGF5OiBDaGVja2JveEJpbmRpbmc7XHJcbiAgcHVibGljIGFuaW1hdGluZzogYm9vbGVhbjtcclxuICBwdWJsaWMgYW5pbWF0aW9uSUQ6IG51bWJlcjtcclxuXHJcbiAgcHVibGljIHRyYW5zZm9ybWluZzogYm9vbGVhbjtcclxuICBwdWJsaWMgbG9ja2VkOiBib29sZWFuO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGJ1ZGdldDogQnVkZ2V0QmluZGluZywgcHJpdmF0ZSBzYXZlT2JqZWN0OiBhbnksXHJcbiAgICAgIHByaXZhdGUgaW5kZXg6IG51bWJlciwgcHVibGljIG5hbWU6IHN0cmluZywgaXNOZXc6IGJvb2xlYW4sXHJcbiAgICAgIHByaXZhdGUgZnJhbWVzOiBGcmFtZUNvdW50cywgcHVibGljIHZhbHVlOiBzdHJpbmcpIHtcclxuICAgIFxyXG4gICAgdGhpcy5jaGVja2JveGVzID0gW1xyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKHNhdmVPYmplY3QsIGluZGV4LCBpc05ldywgMCksXHJcbiAgICAgIG5ldyBDaGVja2JveEJpbmRpbmcoc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3LCAxKSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhzYXZlT2JqZWN0LCBpbmRleCwgaXNOZXcsIDIpLFxyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKHNhdmVPYmplY3QsIGluZGV4LCBpc05ldywgMyksXHJcbiAgICAgIG5ldyBDaGVja2JveEJpbmRpbmcoc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3LCA0KSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhzYXZlT2JqZWN0LCBpbmRleCwgaXNOZXcsIDUpLFxyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKHNhdmVPYmplY3QsIGluZGV4LCBpc05ldywgNilcclxuICAgIF07XHJcbiAgICBcclxuICAgIHRoaXMuIHRyYW5zZm9ybWluZyA9IGZhbHNlO1xyXG4gICAgdGhpcy5hY3Rpb24gPSAnaSc7XHJcbiAgICB0aGlzLmZyYW1lID0gMDtcclxuICAgIGlmKGlzTmV3KSB7XHJcbiAgICAgIHRoaXMuc3RhdGUgPSAwO1xyXG4gICAgICB0aGlzLnNhdmVEYXRhKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnZhbHVlID0gc2F2ZU9iamVjdC5nZXRTdHJpbmcoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJ2YWx1ZVwiKVxyXG4gICAgICB0aGlzLm5hbWUgPSBzYXZlT2JqZWN0LmdldFN0cmluZyhcImhcIiArIHRoaXMuaW5kZXggKyBcIm5hbWVcIik7XHJcbiAgICAgIHRoaXMuc3RhdGUgPSBzYXZlT2JqZWN0LmdldE51bWJlcihcImhcIiArIHRoaXMuaW5kZXggKyBcInN0YXRlSW5kZXhcIik7XHJcbiAgICB9XHJcbiAgICB0aGlzLnNldFN0YXRlKHRoaXMuc3RhdGUpO1xyXG4gICAgdGhpcy5zZXRDaGVja2JveFRpbWVzKGlzTmV3KTtcclxuICB9XHJcblxyXG4gIGRhaWx5VXBkYXRlKHN1Y2Nlc3M6IGJvb2xlYW4pIHtcclxuICAgIGlmKCF0aGlzLmFjdGl2ZURheS5pc1NldCgpKSB7XHJcbiAgICAgIHRoaXMuYWN0aXZlRGF5LmZpbGxDaGVja2JveChzdWNjZXNzKTtcclxuICAgICAgdGhpcy5jaGVja2JveFN0YXRlVXBkYXRlKCk7XHJcbiAgICAgIHRoaXMubG9ja2VkID0gdHJ1ZTtcclxuICAgICAgdGhpcy5zYXZlRGF0YSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY2hlY2tib3hTdGF0ZVVwZGF0ZSgpIHtcclxuICAgIGxldCBuZXdTdGF0ZSA9IDA7XHJcbiAgICBfLmZvckVhY2godGhpcy5jaGVja2JveGVzLCAoYykgPT4ge1xyXG4gICAgICBpZihjLmlzQ2hlY2tlZCgpKSB7XHJcbiAgICAgICAgbmV3U3RhdGUrKztcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYodGhpcy5hY3RpdmVEYXkudGltZSA9PT0gdGhpcy5jaGVja2JveGVzWzZdLnRpbWUpIHtcclxuICAgICAgdGhpcy5lbmRXZWVrKG5ld1N0YXRlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuc2V0U3RhdGUobmV3U3RhdGUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc2V0SW1hZ2UoKSB7XHJcbiAgICB0aGlzLmltYWdlID0gXCJ+L2ltYWdlcy9oXCIgKyB0aGlzLnN0YXRlICsgXCIvXCIgKyB0aGlzLmFjdGlvbiArIHRoaXMuZnJhbWUgKyBcIi5wbmdcIjtcclxuICAgIC8vIGNvbnNvbGUubG9nKFwiaW1hZ2UgY2hhbmdlZCB0bzogXCIgKyB0aGlzLmltYWdlKTtcclxuICB9XHJcblxyXG4gIGFuaW1hdGUoKSB7XHJcbiAgICAgIGlmKHRoaXMuZnJhbWVzLmV4aXN0cyh0aGlzLnN0YXRlLCB0aGlzLmZyYW1lLCB0aGlzLmFjdGlvbikpIHtcclxuICAgICAgICB0aGlzLnNldEltYWdlKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5tYWtlSWRsZSgpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuZnJhbWUrKztcclxuICB9XHJcblxyXG4gIG1ha2VJZGxlKCkge1xyXG4gICAgdGhpcy5yZXNldEJ1c2luZXNzKCk7XHJcbiAgICB0aGlzLmFjdGlvbiA9ICdpJztcclxuICAgIHRoaXMucmVzdGFydEFuaW1hdGlvbigpO1xyXG4gIH1cclxuXHJcbiAgcmVzdGFydEFuaW1hdGlvbigpIHtcclxuICAgIGNsZWFySW50ZXJ2YWwodGhpcy5hbmltYXRpb25JRCk7XHJcbiAgICB0aGlzLmZyYW1lID0gMDtcclxuICAgIHRoaXMuYW5pbWF0aW9uSUQgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgICAgIHRoaXMuYW5pbWF0ZSgpO1xyXG4gICAgfSwgMTAwKTtcclxuICB9XHJcblxyXG4gIHNldFN0YXRlKG5ld1N0YXRlOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IG9sZFN0YXRlID0gdGhpcy5zdGF0ZTtcclxuICAgIHRoaXMuc3RhdGUgPSBuZXdTdGF0ZTtcclxuICAgIGlmKG5ld1N0YXRlICE9PSBvbGRTdGF0ZSkge1xyXG4gICAgICB0aGlzLnRyYW5zZm9ybSgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5tYWtlSWRsZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZW5kV2VlayhzdWNjZXNzZXM6IG51bWJlcikge1xyXG4gICAgdGhpcy5idWRnZXQudXBkYXRlVG90YWwoc3VjY2Vzc2VzLCB0aGlzLnZhbHVlKTtcclxuICAgIHRoaXMuc2V0U3RhdGUoMCk7XHJcbiAgfVxyXG5cclxuICBzYXZlRGF0YSgpIHtcclxuICAgIHRoaXMuc2F2ZU9iamVjdC5zZXRTdHJpbmcoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJ2YWx1ZVwiLCB0aGlzLnZhbHVlKTtcclxuICAgIHRoaXMuc2F2ZU9iamVjdC5zZXRTdHJpbmcoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJuYW1lXCIsIHRoaXMubmFtZSk7XHJcbiAgICB0aGlzLnNhdmVPYmplY3Quc2V0TnVtYmVyKFwiaFwiICsgdGhpcy5pbmRleCArIFwic3RhdGVJbmRleFwiLCB0aGlzLnN0YXRlKTtcclxuICB9XHJcblxyXG4gIHRyYW5zZm9ybSgpIHtcclxuICAgIHRoaXMudHJhbnNmb3JtaW5nID0gdHJ1ZTtcclxuICAgIHRoaXMuYWN0aW9uID0gJ3QnO1xyXG4gICAgdGhpcy5yZXN0YXJ0QW5pbWF0aW9uKCk7XHJcbiAgfVxyXG5cclxuICBhY3QoKSB7XHJcbiAgICBpZiAodGhpcy5pc0J1c3koKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLnRyYW5zZm9ybWluZyA9IGZhbHNlO1xyXG4gICAgY29uc3QgYWN0aW9uVHlwZSA9IE1hdGgucmFuZG9tKCkgKiAyXHJcbiAgICBpZihhY3Rpb25UeXBlIDwgMSAmJiB0aGlzLmZyYW1lcy5leGlzdHModGhpcy5zdGF0ZSwgMCwgJ2EnKSkge1xyXG4gICAgICB0aGlzLmFjdGlvbiA9ICdhJztcclxuICAgIH0gZWxzZSBpZih0aGlzLmZyYW1lcy5leGlzdHModGhpcy5zdGF0ZSwgMCwgJ2InKSkge1xyXG4gICAgICB0aGlzLmFjdGlvbiA9ICdiJztcclxuICAgIH1cclxuICAgIHRoaXMucmVzdGFydEFuaW1hdGlvbigpO1xyXG4gIH1cclxuXHJcbiAgcmVzZXRCdXNpbmVzcygpIHtcclxuICAgIHRoaXMudHJhbnNmb3JtaW5nID0gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBpc0J1c3koKSB7XHJcbiAgICByZXR1cm4gdGhpcy50cmFuc2Zvcm1pbmc7XHJcbiAgfVxyXG5cclxuICB1cGRhdGUobmV3TmFtZTogc3RyaW5nLCBuZXdWYWx1ZTogc3RyaW5nKSB7XHJcbiAgICB0aGlzLm5hbWUgPSBuZXdOYW1lO1xyXG4gICAgdGhpcy52YWx1ZSA9IG5ld1ZhbHVlO1xyXG4gIH1cclxuXHJcbiAgdXBkYXRlSW5kZXgobmV3SW5kZXg6IG51bWJlcikge1xyXG4gICAgdGhpcy5kZWxldGVEYXRhKCk7XHJcbiAgICB0aGlzLmluZGV4ID0gbmV3SW5kZXg7XHJcbiAgICB0aGlzLnNhdmVEYXRhKCk7XHJcbiAgICB0aGlzLmNoYW5nZUNoZWNrYm94SW5kaWNlcygpO1xyXG4gIH1cclxuXHJcbiAgZGVsZXRlRGF0YSgpIHtcclxuICAgIHRoaXMuc2F2ZU9iamVjdC5yZW1vdmUoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJ2YWx1ZVwiKTtcclxuICAgIHRoaXMuc2F2ZU9iamVjdC5yZW1vdmUoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJuYW1lXCIpO1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnJlbW92ZShcImhcIiArIHRoaXMuaW5kZXggKyBcInN0YXRlSW5kZXhcIik7XHJcbiAgfVxyXG5cclxuICBzZXRDaGVja2JveFRpbWVzKGlzTmV3OiBib29sZWFuKSB7XHJcbiAgICBsZXQgdG9kYXkgPSBNb21lbnQoKS5zdGFydE9mKCd3ZWVrJykuc3VidHJhY3QoMSwgJ2RheXMnKTtcclxuICAgIGlmKCFpc05ldyAmJiAgdGhpcy5jaGVja2JveGVzWzZdLnRpbWUgPCB0b2RheS52YWx1ZU9mKCkpIHtcclxuICAgICAgaWYoIXRoaXMuY2hlY2tib3hlc1s2XS5pc1NldCgpKSB7XHJcbiAgICAgICAgbGV0IG51bUNoZWNrZWQgPSAwO1xyXG4gICAgICAgIF8uZm9yRWFjaCh0aGlzLmNoZWNrYm94ZXMsIChjKSA9PiB7XHJcbiAgICAgICAgICBpZihjLmlzQ2hlY2tlZCgpKSB7XHJcbiAgICAgICAgICAgIG51bUNoZWNrZWQrKztcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnN0YXRlID0gMDtcclxuICAgICAgICB0aGlzLmVuZFdlZWsobnVtQ2hlY2tlZCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIF8uZm9yRWFjaCh0aGlzLmNoZWNrYm94ZXMsIChjKSA9PiB7XHJcbiAgICAgICAgYy5yZXNldCgpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNzsgaSsrKSB7XHJcbiAgICAgIHRoaXMuY2hlY2tib3hlc1tpXS5zZXRUaW1lKHRvZGF5LmFkZCgxLCAnZGF5cycpLmZvcm1hdCgnZGRkZCBEbyBNTU0nKSwgdG9kYXkudmFsdWVPZigpKTtcclxuICAgICAgaWYodGhpcy5jaGVja2JveGVzW2ldLnRpbWUgPCBNb21lbnQoKS5lbmRPZignZGF5JykudmFsdWVPZigpKSB7XHJcbiAgICAgICAgdGhpcy5hY3RpdmVEYXkgPSB0aGlzLmNoZWNrYm94ZXNbaV07XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMubG9ja2VkID0gdGhpcy5hY3RpdmVEYXkuaXNTZXQoKTtcclxuICB9XHJcblxyXG4gIGNoYW5nZUNoZWNrYm94SW5kaWNlcygpIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNzsgaSsrKSB7XHJcbiAgICAgIHRoaXMuY2hlY2tib3hlc1tpXS5jaGFuZ2VJbmRleCh0aGlzLmluZGV4KTtcclxuICAgIH1cclxuICB9XHJcbn0iXX0=