"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var checkbox_1 = require("./checkbox");
var _ = require("lodash");
var Moment = require("moment");
var HabbajetBinding = /** @class */ (function () {
    function HabbajetBinding(budget, saveObject, index, name, isNew, frames, value) {
        this.budget = budget;
        this.saveObject = saveObject;
        this.index = index;
        this.name = name;
        this.frames = frames;
        this.value = value;
        this.checkboxes = [
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 0),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 1),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 2),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 3),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 4),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 5),
            new checkbox_1.CheckboxBinding(saveObject, index, isNew, 6)
        ];
        this.setCheckboxTimes();
        this.acting = false;
        this.transforming = false;
        this.action = 'i';
        this.frame = 0;
        if (isNew) {
            this.state = 0;
            this.saveData();
        }
        else {
            this.value = saveObject.getString("h" + this.index + "value");
            this.name = saveObject.getString("h" + this.index + "name");
            this.state = saveObject.getNumber("h" + this.index + "stateIndex");
        }
        this.setActiveDay();
        this.setState(this.state);
    }
    HabbajetBinding.prototype.dailyUpdate = function (success) {
        if (!this.isBusy()) {
            this.activeDay.fillCheckbox(success);
            this.checkboxStateUpdate();
            this.saveData();
        }
    };
    HabbajetBinding.prototype.checkboxStateUpdate = function () {
        var newState = 0;
        var numSetBoxes = 0;
        _.forEach(this.checkboxes, function (c) {
            if (c.isChecked()) {
                newState++;
            }
            if (c.isSet()) {
                numSetBoxes++;
            }
        });
        if (numSetBoxes > 6) {
            this.endWeek(newState);
        }
        else {
            this.setState(newState);
        }
        this.setActiveDay();
    };
    HabbajetBinding.prototype.setImage = function () {
        this.image = "~/images/h" + this.state + "/" + this.action + this.frame + ".png";
        // console.log("image changed to: " + this.image);
    };
    HabbajetBinding.prototype.animate = function () {
        if (this.frames.exists(this.state, this.frame, this.action)) {
            this.setImage();
        }
        else {
            this.makeIdle();
        }
        this.frame++;
    };
    HabbajetBinding.prototype.makeIdle = function () {
        this.resetBusiness();
        this.action = 'i';
        this.restartAnimation();
    };
    HabbajetBinding.prototype.restartAnimation = function () {
        var _this = this;
        clearInterval(this.animationID);
        this.frame = 0;
        this.animationID = setInterval(function () {
            _this.animate();
        }, 100);
    };
    HabbajetBinding.prototype.setState = function (newState) {
        var oldState = this.state;
        this.state = newState;
        if (newState !== oldState) {
            this.transform();
        }
        else {
            this.makeIdle();
        }
    };
    HabbajetBinding.prototype.endWeek = function (successes) {
        this.budget.updateTotal(successes, this.value);
        _.forEach(this.checkboxes, function (c) {
            c.reset();
        });
        this.setState(0);
    };
    HabbajetBinding.prototype.setActiveDay = function () {
        for (var i = 0; i < this.checkboxes.length; i++) {
            if (!this.checkboxes[i].isSet()) {
                this.activeDay = this.checkboxes[i];
                return;
            }
        }
    };
    HabbajetBinding.prototype.saveData = function () {
        this.saveObject.setString("h" + this.index + "value", this.value);
        this.saveObject.setString("h" + this.index + "name", this.name);
        this.saveObject.setNumber("h" + this.index + "stateIndex", this.state);
    };
    HabbajetBinding.prototype.transform = function () {
        this.transforming = true;
        this.action = 't';
        this.restartAnimation();
    };
    HabbajetBinding.prototype.act = function () {
        if (this.isBusy()) {
            return;
        }
        this.transforming = false;
        var actionType = Math.random() * 2;
        if (actionType < 1 && this.frames.exists(this.state, 0, 'a')) {
            this.action = 'a';
        }
        else if (this.frames.exists(this.state, 0, 'b')) {
            this.action = 'b';
        }
        this.restartAnimation();
    };
    HabbajetBinding.prototype.resetBusiness = function () {
        this.acting = false;
        this.transforming = false;
    };
    HabbajetBinding.prototype.isBusy = function () {
        return this.acting || this.transforming;
    };
    HabbajetBinding.prototype.update = function (newName, newValue) {
        this.name = newName;
        this.value = newValue;
    };
    HabbajetBinding.prototype.updateIndex = function (newIndex) {
        this.deleteData();
        this.index = newIndex;
        this.saveData();
        this.changeCheckboxIndices();
    };
    HabbajetBinding.prototype.deleteData = function () {
        this.saveObject.remove("h" + this.index + "value");
        this.saveObject.remove("h" + this.index + "name");
        this.saveObject.remove("h" + this.index + "stateIndex");
    };
    HabbajetBinding.prototype.setCheckboxTimes = function () {
        var today = Moment().startOf('week');
        for (var i = 0; i < 7; i++) {
            this.checkboxes[i].setTime(today.add(1, 'days').format('dddd Do MMM'), today.valueOf());
            if (this.checkboxes[i].time < Moment().endOf('day').valueOf()) {
                this.activeDay = this.checkboxes[i];
            }
        }
    };
    HabbajetBinding.prototype.changeCheckboxIndices = function () {
        for (var i = 0; i < 7; i++) {
            this.checkboxes[i].changeIndex(this.index);
        }
    };
    return HabbajetBinding;
}());
exports.HabbajetBinding = HabbajetBinding;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFiYmFqZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJoYWJiYWpldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUE2QztBQUM3QywwQkFBNEI7QUFJNUIsK0JBQWlDO0FBRWpDO0lBYUUseUJBQW9CLE1BQXFCLEVBQVUsVUFBZSxFQUN0RCxLQUFhLEVBQVMsSUFBWSxFQUFFLEtBQWMsRUFDbEQsTUFBbUIsRUFBUyxLQUFhO1FBRmpDLFdBQU0sR0FBTixNQUFNLENBQWU7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFLO1FBQ3RELFVBQUssR0FBTCxLQUFLLENBQVE7UUFBUyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQWE7UUFBUyxVQUFLLEdBQUwsS0FBSyxDQUFRO1FBRW5ELElBQUksQ0FBQyxVQUFVLEdBQUc7WUFDaEIsSUFBSSwwQkFBZSxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNoRCxJQUFJLDBCQUFlLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ2hELElBQUksMEJBQWUsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDaEQsSUFBSSwwQkFBZSxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNoRCxJQUFJLDBCQUFlLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ2hELElBQUksMEJBQWUsQ0FBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDaEQsSUFBSSwwQkFBZSxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUNqRCxDQUFDO1FBQ0YsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLE1B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QUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUMzQixJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDN0MsQ0FBQztJQUNILENBQUM7SUFDSCxzQkFBQztBQUFELENBQUMsQUFsTUQsSUFrTUM7QUFsTVksMENBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGVja2JveEJpbmRpbmcgfSBmcm9tIFwiLi9jaGVja2JveFwiO1xyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XHJcbmltcG9ydCAqIGFzIERpYWxvZ3MgZnJvbSAndWkvZGlhbG9ncyc7XHJcbmltcG9ydCB7IEJ1ZGdldEJpbmRpbmcgfSBmcm9tIFwiLi9idWRnZXRcIjtcclxuaW1wb3J0IHsgRnJhbWVDb3VudHMgfSBmcm9tIFwiLi9mcmFtZS1jb3VudHNcIjtcclxuaW1wb3J0ICogYXMgTW9tZW50IGZyb20gXCJtb21lbnRcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBIYWJiYWpldEJpbmRpbmcge1xyXG4gIHByaXZhdGUgc3RhdGU6IG51bWJlcjtcclxuICBwcml2YXRlIGZyYW1lOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBhY3Rpb246IHN0cmluZztcclxuICBwdWJsaWMgaW1hZ2U6IHN0cmluZztcclxuICBwdWJsaWMgY2hlY2tib3hlczogQ2hlY2tib3hCaW5kaW5nW107XHJcbiAgcHVibGljIGFjdGl2ZURheTogQ2hlY2tib3hCaW5kaW5nO1xyXG4gIHB1YmxpYyBhbmltYXRpbmc6IGJvb2xlYW47XHJcbiAgcHVibGljIGFuaW1hdGlvbklEOiBudW1iZXI7XHJcblxyXG4gIHB1YmxpYyB0cmFuc2Zvcm1pbmc6IGJvb2xlYW47XHJcbiAgcHJpdmF0ZSBhY3Rpbmc6IGJvb2xlYW47XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYnVkZ2V0OiBCdWRnZXRCaW5kaW5nLCBwcml2YXRlIHNhdmVPYmplY3Q6IGFueSxcclxuICAgICAgcHJpdmF0ZSBpbmRleDogbnVtYmVyLCBwdWJsaWMgbmFtZTogc3RyaW5nLCBpc05ldzogYm9vbGVhbixcclxuICAgICAgcHJpdmF0ZSBmcmFtZXM6IEZyYW1lQ291bnRzLCBwdWJsaWMgdmFsdWU6IHN0cmluZykge1xyXG4gICAgXHJcbiAgICB0aGlzLmNoZWNrYm94ZXMgPSBbXHJcbiAgICAgIG5ldyBDaGVja2JveEJpbmRpbmcoc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3LCAwKSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhzYXZlT2JqZWN0LCBpbmRleCwgaXNOZXcsIDEpLFxyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKHNhdmVPYmplY3QsIGluZGV4LCBpc05ldywgMiksXHJcbiAgICAgIG5ldyBDaGVja2JveEJpbmRpbmcoc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3LCAzKSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhzYXZlT2JqZWN0LCBpbmRleCwgaXNOZXcsIDQpLFxyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKHNhdmVPYmplY3QsIGluZGV4LCBpc05ldywgNSksXHJcbiAgICAgIG5ldyBDaGVja2JveEJpbmRpbmcoc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3LCA2KVxyXG4gICAgXTtcclxuICAgIHRoaXMuc2V0Q2hlY2tib3hUaW1lcygpO1xyXG4gICAgdGhpcy5hY3RpbmcgPSBmYWxzZTtcclxuICAgIHRoaXMuIHRyYW5zZm9ybWluZyA9IGZhbHNlO1xyXG4gICAgdGhpcy5hY3Rpb24gPSAnaSc7XHJcbiAgICB0aGlzLmZyYW1lID0gMDtcclxuICAgIGlmKGlzTmV3KSB7XHJcbiAgICAgIHRoaXMuc3RhdGUgPSAwO1xyXG4gICAgICB0aGlzLnNhdmVEYXRhKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnZhbHVlID0gc2F2ZU9iamVjdC5nZXRTdHJpbmcoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJ2YWx1ZVwiKVxyXG4gICAgICB0aGlzLm5hbWUgPSBzYXZlT2JqZWN0LmdldFN0cmluZyhcImhcIiArIHRoaXMuaW5kZXggKyBcIm5hbWVcIik7XHJcbiAgICAgIHRoaXMuc3RhdGUgPSBzYXZlT2JqZWN0LmdldE51bWJlcihcImhcIiArIHRoaXMuaW5kZXggKyBcInN0YXRlSW5kZXhcIik7XHJcbiAgICB9XHJcbiAgICB0aGlzLnNldEFjdGl2ZURheSgpO1xyXG4gICAgdGhpcy5zZXRTdGF0ZSh0aGlzLnN0YXRlKTtcclxuICB9XHJcblxyXG4gIGRhaWx5VXBkYXRlKHN1Y2Nlc3M6IGJvb2xlYW4pIHtcclxuICAgIGlmKCF0aGlzLmlzQnVzeSgpKSB7XHJcbiAgICAgIHRoaXMuYWN0aXZlRGF5LmZpbGxDaGVja2JveChzdWNjZXNzKTtcclxuICAgICAgdGhpcy5jaGVja2JveFN0YXRlVXBkYXRlKCk7XHJcbiAgICAgIHRoaXMuc2F2ZURhdGEoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNoZWNrYm94U3RhdGVVcGRhdGUoKSB7XHJcbiAgICBsZXQgbmV3U3RhdGUgPSAwO1xyXG4gICAgbGV0IG51bVNldEJveGVzID0gMDtcclxuICAgIF8uZm9yRWFjaCh0aGlzLmNoZWNrYm94ZXMsIChjKSA9PiB7XHJcbiAgICAgIGlmKGMuaXNDaGVja2VkKCkpIHtcclxuICAgICAgICBuZXdTdGF0ZSsrO1xyXG4gICAgICB9XHJcbiAgICAgIGlmKGMuaXNTZXQoKSkge1xyXG4gICAgICAgIG51bVNldEJveGVzKys7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGlmKG51bVNldEJveGVzID4gNikge1xyXG4gICAgICB0aGlzLmVuZFdlZWsobmV3U3RhdGUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5zZXRTdGF0ZShuZXdTdGF0ZSk7XHJcbiAgICB9XHJcbiAgICB0aGlzLnNldEFjdGl2ZURheSgpO1xyXG4gIH1cclxuXHJcbiAgc2V0SW1hZ2UoKSB7XHJcbiAgICB0aGlzLmltYWdlID0gXCJ+L2ltYWdlcy9oXCIgKyB0aGlzLnN0YXRlICsgXCIvXCIgKyB0aGlzLmFjdGlvbiArIHRoaXMuZnJhbWUgKyBcIi5wbmdcIjtcclxuICAgIC8vIGNvbnNvbGUubG9nKFwiaW1hZ2UgY2hhbmdlZCB0bzogXCIgKyB0aGlzLmltYWdlKTtcclxuICB9XHJcblxyXG4gIGFuaW1hdGUoKSB7XHJcbiAgICAgIGlmKHRoaXMuZnJhbWVzLmV4aXN0cyh0aGlzLnN0YXRlLCB0aGlzLmZyYW1lLCB0aGlzLmFjdGlvbikpIHtcclxuICAgICAgICB0aGlzLnNldEltYWdlKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5tYWtlSWRsZSgpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuZnJhbWUrKztcclxuICB9XHJcblxyXG4gIG1ha2VJZGxlKCkge1xyXG4gICAgdGhpcy5yZXNldEJ1c2luZXNzKCk7XHJcbiAgICB0aGlzLmFjdGlvbiA9ICdpJztcclxuICAgIHRoaXMucmVzdGFydEFuaW1hdGlvbigpO1xyXG4gIH1cclxuXHJcbiAgcmVzdGFydEFuaW1hdGlvbigpIHtcclxuICAgIGNsZWFySW50ZXJ2YWwodGhpcy5hbmltYXRpb25JRCk7XHJcbiAgICB0aGlzLmZyYW1lID0gMDtcclxuICAgIHRoaXMuYW5pbWF0aW9uSUQgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgICAgIHRoaXMuYW5pbWF0ZSgpO1xyXG4gICAgfSwgMTAwKTtcclxuICB9XHJcblxyXG4gIHNldFN0YXRlKG5ld1N0YXRlOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IG9sZFN0YXRlID0gdGhpcy5zdGF0ZTtcclxuICAgIHRoaXMuc3RhdGUgPSBuZXdTdGF0ZTtcclxuICAgIGlmKG5ld1N0YXRlICE9PSBvbGRTdGF0ZSkge1xyXG4gICAgICB0aGlzLnRyYW5zZm9ybSgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5tYWtlSWRsZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZW5kV2VlayhzdWNjZXNzZXM6IG51bWJlcikge1xyXG4gICAgdGhpcy5idWRnZXQudXBkYXRlVG90YWwoc3VjY2Vzc2VzLCB0aGlzLnZhbHVlKTtcclxuICAgIF8uZm9yRWFjaCh0aGlzLmNoZWNrYm94ZXMsIChjKSA9PiB7XHJcbiAgICAgIGMucmVzZXQoKTtcclxuICAgIH0pO1xyXG4gICAgdGhpcy5zZXRTdGF0ZSgwKTtcclxuICB9XHJcblxyXG4gIHNldEFjdGl2ZURheSgpIHtcclxuICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLmNoZWNrYm94ZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgaWYgKCF0aGlzLmNoZWNrYm94ZXNbaV0uaXNTZXQoKSkge1xyXG4gICAgICAgIHRoaXMuYWN0aXZlRGF5ID0gdGhpcy5jaGVja2JveGVzW2ldO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc2F2ZURhdGEoKSB7XHJcbiAgICB0aGlzLnNhdmVPYmplY3Quc2V0U3RyaW5nKFwiaFwiICsgdGhpcy5pbmRleCArIFwidmFsdWVcIiwgdGhpcy52YWx1ZSk7XHJcbiAgICB0aGlzLnNhdmVPYmplY3Quc2V0U3RyaW5nKFwiaFwiICsgdGhpcy5pbmRleCArIFwibmFtZVwiLCB0aGlzLm5hbWUpO1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnNldE51bWJlcihcImhcIiArIHRoaXMuaW5kZXggKyBcInN0YXRlSW5kZXhcIiwgdGhpcy5zdGF0ZSk7XHJcbiAgfVxyXG5cclxuICB0cmFuc2Zvcm0oKSB7XHJcbiAgICB0aGlzLnRyYW5zZm9ybWluZyA9IHRydWU7XHJcbiAgICB0aGlzLmFjdGlvbiA9ICd0JztcclxuICAgIHRoaXMucmVzdGFydEFuaW1hdGlvbigpO1xyXG4gIH1cclxuXHJcbiAgYWN0KCkge1xyXG4gICAgaWYgKHRoaXMuaXNCdXN5KCkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy50cmFuc2Zvcm1pbmcgPSBmYWxzZTtcclxuICAgIGNvbnN0IGFjdGlvblR5cGUgPSBNYXRoLnJhbmRvbSgpICogMlxyXG4gICAgaWYoYWN0aW9uVHlwZSA8IDEgJiYgdGhpcy5mcmFtZXMuZXhpc3RzKHRoaXMuc3RhdGUsIDAsICdhJykpIHtcclxuICAgICAgdGhpcy5hY3Rpb24gPSAnYSc7XHJcbiAgICB9IGVsc2UgaWYodGhpcy5mcmFtZXMuZXhpc3RzKHRoaXMuc3RhdGUsIDAsICdiJykpIHtcclxuICAgICAgdGhpcy5hY3Rpb24gPSAnYic7XHJcbiAgICB9XHJcbiAgICB0aGlzLnJlc3RhcnRBbmltYXRpb24oKTtcclxuICB9XHJcblxyXG4gIHJlc2V0QnVzaW5lc3MoKSB7XHJcbiAgICB0aGlzLmFjdGluZyA9IGZhbHNlO1xyXG4gICAgdGhpcy50cmFuc2Zvcm1pbmcgPSBmYWxzZTtcclxuICB9XHJcblxyXG4gIGlzQnVzeSgpIHtcclxuICAgIHJldHVybiB0aGlzLmFjdGluZyB8fCB0aGlzLnRyYW5zZm9ybWluZztcclxuICB9XHJcblxyXG4gIHVwZGF0ZShuZXdOYW1lOiBzdHJpbmcsIG5ld1ZhbHVlOiBzdHJpbmcpIHtcclxuICAgIHRoaXMubmFtZSA9IG5ld05hbWU7XHJcbiAgICB0aGlzLnZhbHVlID0gbmV3VmFsdWU7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVJbmRleChuZXdJbmRleDogbnVtYmVyKSB7XHJcbiAgICB0aGlzLmRlbGV0ZURhdGEoKTtcclxuICAgIHRoaXMuaW5kZXggPSBuZXdJbmRleDtcclxuICAgIHRoaXMuc2F2ZURhdGEoKTtcclxuICAgIHRoaXMuY2hhbmdlQ2hlY2tib3hJbmRpY2VzKCk7XHJcbiAgfVxyXG5cclxuICBkZWxldGVEYXRhKCkge1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnJlbW92ZShcImhcIiArIHRoaXMuaW5kZXggKyBcInZhbHVlXCIpO1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnJlbW92ZShcImhcIiArIHRoaXMuaW5kZXggKyBcIm5hbWVcIik7XHJcbiAgICB0aGlzLnNhdmVPYmplY3QucmVtb3ZlKFwiaFwiICsgdGhpcy5pbmRleCArIFwic3RhdGVJbmRleFwiKTtcclxuICB9XHJcblxyXG4gIHNldENoZWNrYm94VGltZXMoKSB7XHJcbiAgICBsZXQgdG9kYXkgPSBNb21lbnQoKS5zdGFydE9mKCd3ZWVrJyk7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDc7IGkrKykge1xyXG4gICAgICB0aGlzLmNoZWNrYm94ZXNbaV0uc2V0VGltZSh0b2RheS5hZGQoMSwgJ2RheXMnKS5mb3JtYXQoJ2RkZGQgRG8gTU1NJyksIHRvZGF5LnZhbHVlT2YoKSk7XHJcbiAgICAgIGlmKHRoaXMuY2hlY2tib3hlc1tpXS50aW1lIDwgTW9tZW50KCkuZW5kT2YoJ2RheScpLnZhbHVlT2YoKSkge1xyXG4gICAgICAgIHRoaXMuYWN0aXZlRGF5ID0gdGhpcy5jaGVja2JveGVzW2ldO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjaGFuZ2VDaGVja2JveEluZGljZXMoKSB7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDc7IGkrKykge1xyXG4gICAgICB0aGlzLmNoZWNrYm94ZXNbaV0uY2hhbmdlSW5kZXgodGhpcy5pbmRleCk7XHJcbiAgICB9XHJcbiAgfVxyXG59Il19