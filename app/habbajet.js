"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var checkbox_1 = require("./checkbox");
var _ = require("lodash");
var HabbajetBinding = /** @class */ (function () {
    function HabbajetBinding(budget, saveObject, index, name, isNew, frames) {
        this.budget = budget;
        this.saveObject = saveObject;
        this.index = index;
        this.name = name;
        this.frames = frames;
        this.checkboxes = [
            new checkbox_1.CheckboxBinding("Sunday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Monday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Tuesday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Wednesday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Thursday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Friday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Saturday", saveObject, index, isNew)
        ];
        this.acting = false;
        this.transforming = false;
        this.action = 'i';
        this.frame = 0;
        if (isNew) {
            this.state = 0;
            this.saveData();
        }
        else {
            this.name = saveObject.getString("h" + this.index + "name");
            this.state = saveObject.getNumber("h" + this.index + "stateIndex");
        }
        this.setActiveDay();
        this.setState(this.state);
    }
    HabbajetBinding.prototype.dailyUpdate = function (success) {
        if (!this.isBusy()) {
            this.activeDay.fillCheckbox(success);
            this.checkboxStateUpdate();
            this.saveData();
        }
    };
    HabbajetBinding.prototype.checkboxStateUpdate = function () {
        var newState = 0;
        var numSetBoxes = 0;
        _.forEach(this.checkboxes, function (c) {
            if (c.isChecked()) {
                newState++;
            }
            if (c.isSet()) {
                numSetBoxes++;
            }
        });
        if (numSetBoxes > 6) {
            this.endWeek(newState);
        }
        else {
            this.setState(newState);
        }
        this.setActiveDay();
    };
    HabbajetBinding.prototype.setImage = function () {
        this.image = "~/images/h" + this.state + "/" + this.action + this.frame + ".png";
        // console.log("image changed to: " + this.image);
    };
    HabbajetBinding.prototype.animate = function () {
        if (this.frames.exists(this.state, this.frame, this.action)) {
            this.setImage();
        }
        else {
            this.makeIdle();
        }
        this.frame++;
    };
    HabbajetBinding.prototype.makeIdle = function () {
        this.resetBusiness();
        this.action = 'i';
        this.restartAnimation();
    };
    HabbajetBinding.prototype.restartAnimation = function () {
        var _this = this;
        clearInterval(this.animationID);
        this.frame = 0;
        this.animationID = setInterval(function () {
            _this.animate();
        }, 100);
    };
    HabbajetBinding.prototype.setState = function (newState) {
        this.state = newState;
        this.transform();
    };
    HabbajetBinding.prototype.endWeek = function (successes) {
        this.budget.updateTotal(successes);
        _.forEach(this.checkboxes, function (c) {
            c.reset();
        });
        this.setState(0);
    };
    HabbajetBinding.prototype.setActiveDay = function () {
        for (var i = 0; i < this.checkboxes.length; i++) {
            if (!this.checkboxes[i].isSet()) {
                this.activeDay = this.checkboxes[i];
                return;
            }
        }
    };
    HabbajetBinding.prototype.saveData = function () {
        this.saveObject.setString("h" + this.index + "name", this.name);
        this.saveObject.setNumber("h" + this.index + "stateIndex", this.state);
    };
    HabbajetBinding.prototype.transform = function () {
        this.transforming = true;
        this.action = 't';
        this.restartAnimation();
    };
    HabbajetBinding.prototype.act = function () {
        if (this.isBusy()) {
            return;
        }
        this.transforming = false;
        var actionType = Math.random() * 2;
        if (actionType < 1) {
            this.action = 'a';
        }
        else {
            this.action = 'b';
        }
        this.restartAnimation();
    };
    HabbajetBinding.prototype.resetBusiness = function () {
        this.acting = false;
        this.transforming = false;
    };
    HabbajetBinding.prototype.isBusy = function () {
        return this.acting || this.transforming;
    };
    return HabbajetBinding;
}());
exports.HabbajetBinding = HabbajetBinding;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFiYmFqZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJoYWJiYWpldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUE2QztBQUM3QywwQkFBNEI7QUFLNUI7SUFhRSx5QkFBb0IsTUFBcUIsRUFBVSxVQUFlLEVBQ3RELEtBQWEsRUFBUyxJQUFZLEVBQUUsS0FBYyxFQUFVLE1BQW1CO1FBRHZFLFdBQU0sR0FBTixNQUFNLENBQWU7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFLO1FBQ3RELFVBQUssR0FBTCxLQUFLLENBQVE7UUFBUyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQTBCLFdBQU0sR0FBTixNQUFNLENBQWE7UUFFekYsSUFBSSxDQUFDLFVBQVUsR0FBRztZQUNoQixJQUFJLDBCQUFlLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDO1lBQ3ZELElBQUksMEJBQWUsQ0FBQyxRQUFRLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUM7WUFDdkQsSUFBSSwwQkFBZSxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQztZQUN4RCxJQUFJLDBCQUFlLENBQUMsV0FBVyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDO1lBQzFELElBQUksMEJBQWUsQ0FBQyxVQUFVLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUM7WUFDekQsSUFBSSwwQkFBZSxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQztZQUN2RCxJQUFJLDBCQUFlLENBQUMsVUFBVSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDO1NBQzFELENBQUM7UUFDRixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUUsWUFBWSxHQUFHLEtBQUssQ0FBQztRQUMzQixJQUFJLENBQUMsTUFBTSxHQUFHLEdB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O0lBQ0gsc0JBQUM7QUFBRCxDQUFDLEFBdkpELElBdUpDO0FBdkpZLDBDQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hlY2tib3hCaW5kaW5nIH0gZnJvbSBcIi4vY2hlY2tib3hcIjtcclxuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xyXG5pbXBvcnQgKiBhcyBEaWFsb2dzIGZyb20gJ3VpL2RpYWxvZ3MnO1xyXG5pbXBvcnQgeyBCdWRnZXRCaW5kaW5nIH0gZnJvbSBcIi4vYnVkZ2V0XCI7XHJcbmltcG9ydCB7IEZyYW1lQ291bnRzIH0gZnJvbSBcIi4vZnJhbWUtY291bnRzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgSGFiYmFqZXRCaW5kaW5nIHtcclxuICBwcml2YXRlIHN0YXRlOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBmcmFtZTogbnVtYmVyO1xyXG4gIHByaXZhdGUgYWN0aW9uOiBzdHJpbmc7XHJcbiAgcHVibGljIGltYWdlOiBzdHJpbmc7XHJcbiAgcHVibGljIGNoZWNrYm94ZXM6IENoZWNrYm94QmluZGluZ1tdO1xyXG4gIHB1YmxpYyBhY3RpdmVEYXk6IENoZWNrYm94QmluZGluZztcclxuICBwdWJsaWMgYW5pbWF0aW5nOiBib29sZWFuO1xyXG4gIHB1YmxpYyBhbmltYXRpb25JRDogbnVtYmVyO1xyXG5cclxuICBwcml2YXRlIHRyYW5zZm9ybWluZzogYm9vbGVhbjtcclxuICBwcml2YXRlIGFjdGluZzogYm9vbGVhbjtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBidWRnZXQ6IEJ1ZGdldEJpbmRpbmcsIHByaXZhdGUgc2F2ZU9iamVjdDogYW55LFxyXG4gICAgICBwcml2YXRlIGluZGV4OiBudW1iZXIsIHB1YmxpYyBuYW1lOiBzdHJpbmcsIGlzTmV3OiBib29sZWFuLCBwcml2YXRlIGZyYW1lczogRnJhbWVDb3VudHMpIHtcclxuICAgIFxyXG4gICAgdGhpcy5jaGVja2JveGVzID0gW1xyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKFwiU3VuZGF5XCIsIHNhdmVPYmplY3QsIGluZGV4LCBpc05ldyksXHJcbiAgICAgIG5ldyBDaGVja2JveEJpbmRpbmcoXCJNb25kYXlcIiwgc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3KSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhcIlR1ZXNkYXlcIiwgc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3KSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhcIldlZG5lc2RheVwiLCBzYXZlT2JqZWN0LCBpbmRleCwgaXNOZXcpLFxyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKFwiVGh1cnNkYXlcIiwgc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3KSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhcIkZyaWRheVwiLCBzYXZlT2JqZWN0LCBpbmRleCwgaXNOZXcpLFxyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKFwiU2F0dXJkYXlcIiwgc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3KVxyXG4gICAgXTtcclxuICAgIHRoaXMuYWN0aW5nID0gZmFsc2U7XHJcbiAgICB0aGlzLiB0cmFuc2Zvcm1pbmcgPSBmYWxzZTtcclxuICAgIHRoaXMuYWN0aW9uID0gJ2knO1xyXG4gICAgdGhpcy5mcmFtZSA9IDA7XHJcbiAgICBpZihpc05ldykge1xyXG4gICAgICB0aGlzLnN0YXRlID0gMDtcclxuICAgICAgdGhpcy5zYXZlRGF0YSgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5uYW1lID0gc2F2ZU9iamVjdC5nZXRTdHJpbmcoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJuYW1lXCIpO1xyXG4gICAgICB0aGlzLnN0YXRlID0gc2F2ZU9iamVjdC5nZXROdW1iZXIoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJzdGF0ZUluZGV4XCIpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zZXRBY3RpdmVEYXkoKTtcclxuICAgIHRoaXMuc2V0U3RhdGUodGhpcy5zdGF0ZSk7XHJcbiAgfVxyXG5cclxuICBkYWlseVVwZGF0ZShzdWNjZXNzOiBib29sZWFuKSB7XHJcbiAgICBpZighdGhpcy5pc0J1c3koKSkge1xyXG4gICAgICB0aGlzLmFjdGl2ZURheS5maWxsQ2hlY2tib3goc3VjY2Vzcyk7XHJcbiAgICAgIHRoaXMuY2hlY2tib3hTdGF0ZVVwZGF0ZSgpO1xyXG4gICAgICB0aGlzLnNhdmVEYXRhKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjaGVja2JveFN0YXRlVXBkYXRlKCkge1xyXG4gICAgbGV0IG5ld1N0YXRlID0gMDtcclxuICAgIGxldCBudW1TZXRCb3hlcyA9IDA7XHJcbiAgICBfLmZvckVhY2godGhpcy5jaGVja2JveGVzLCAoYykgPT4ge1xyXG4gICAgICBpZihjLmlzQ2hlY2tlZCgpKSB7XHJcbiAgICAgICAgbmV3U3RhdGUrKztcclxuICAgICAgfVxyXG4gICAgICBpZihjLmlzU2V0KCkpIHtcclxuICAgICAgICBudW1TZXRCb3hlcysrO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZihudW1TZXRCb3hlcyA+IDYpIHtcclxuICAgICAgdGhpcy5lbmRXZWVrKG5ld1N0YXRlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuc2V0U3RhdGUobmV3U3RhdGUpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zZXRBY3RpdmVEYXkoKTtcclxuICB9XHJcblxyXG4gIHNldEltYWdlKCkge1xyXG4gICAgdGhpcy5pbWFnZSA9IFwifi9pbWFnZXMvaFwiICsgdGhpcy5zdGF0ZSArIFwiL1wiICsgdGhpcy5hY3Rpb24gKyB0aGlzLmZyYW1lICsgXCIucG5nXCI7XHJcbiAgICAvLyBjb25zb2xlLmxvZyhcImltYWdlIGNoYW5nZWQgdG86IFwiICsgdGhpcy5pbWFnZSk7XHJcbiAgfVxyXG5cclxuICBhbmltYXRlKCkge1xyXG4gICAgICBpZih0aGlzLmZyYW1lcy5leGlzdHModGhpcy5zdGF0ZSwgdGhpcy5mcmFtZSwgdGhpcy5hY3Rpb24pKSB7XHJcbiAgICAgICAgdGhpcy5zZXRJbWFnZSgpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMubWFrZUlkbGUoKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmZyYW1lKys7XHJcbiAgfVxyXG5cclxuICBtYWtlSWRsZSgpIHtcclxuICAgIHRoaXMucmVzZXRCdXNpbmVzcygpO1xyXG4gICAgdGhpcy5hY3Rpb24gPSAnaSc7XHJcbiAgICB0aGlzLnJlc3RhcnRBbmltYXRpb24oKTtcclxuICB9XHJcblxyXG4gIHJlc3RhcnRBbmltYXRpb24oKSB7XHJcbiAgICBjbGVhckludGVydmFsKHRoaXMuYW5pbWF0aW9uSUQpO1xyXG4gICAgdGhpcy5mcmFtZSA9IDA7XHJcbiAgICB0aGlzLmFuaW1hdGlvbklEID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICB0aGlzLmFuaW1hdGUoKTtcclxuICAgIH0sIDEwMCk7XHJcbiAgfVxyXG5cclxuICBzZXRTdGF0ZShuZXdTdGF0ZTogbnVtYmVyKSB7XHJcbiAgICB0aGlzLnN0YXRlID0gbmV3U3RhdGU7XHJcbiAgICB0aGlzLnRyYW5zZm9ybSgpO1xyXG4gIH1cclxuXHJcbiAgZW5kV2VlayhzdWNjZXNzZXM6IG51bWJlcikge1xyXG4gICAgdGhpcy5idWRnZXQudXBkYXRlVG90YWwoc3VjY2Vzc2VzKTtcclxuICAgIF8uZm9yRWFjaCh0aGlzLmNoZWNrYm94ZXMsIChjKSA9PiB7XHJcbiAgICAgIGMucmVzZXQoKTtcclxuICAgIH0pO1xyXG4gICAgdGhpcy5zZXRTdGF0ZSgwKTtcclxuICB9XHJcblxyXG4gIHNldEFjdGl2ZURheSgpIHtcclxuICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLmNoZWNrYm94ZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgaWYgKCF0aGlzLmNoZWNrYm94ZXNbaV0uaXNTZXQoKSkge1xyXG4gICAgICAgIHRoaXMuYWN0aXZlRGF5ID0gdGhpcy5jaGVja2JveGVzW2ldO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc2F2ZURhdGEoKSB7XHJcbiAgICB0aGlzLnNhdmVPYmplY3Quc2V0U3RyaW5nKFwiaFwiICsgdGhpcy5pbmRleCArIFwibmFtZVwiLCB0aGlzLm5hbWUpO1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnNldE51bWJlcihcImhcIiArIHRoaXMuaW5kZXggKyBcInN0YXRlSW5kZXhcIiwgdGhpcy5zdGF0ZSk7XHJcbiAgfVxyXG5cclxuICB0cmFuc2Zvcm0oKSB7XHJcbiAgICB0aGlzLnRyYW5zZm9ybWluZyA9IHRydWU7XHJcbiAgICB0aGlzLmFjdGlvbiA9ICd0JztcclxuICAgIHRoaXMucmVzdGFydEFuaW1hdGlvbigpO1xyXG4gIH1cclxuXHJcbiAgYWN0KCkge1xyXG4gICAgaWYgKHRoaXMuaXNCdXN5KCkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy50cmFuc2Zvcm1pbmcgPSBmYWxzZTtcclxuICAgIGNvbnN0IGFjdGlvblR5cGUgPSBNYXRoLnJhbmRvbSgpICogMlxyXG4gICAgaWYoYWN0aW9uVHlwZSA8IDEpIHtcclxuICAgICAgdGhpcy5hY3Rpb24gPSAnYSc7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmFjdGlvbiA9ICdiJztcclxuICAgIH1cclxuICAgIHRoaXMucmVzdGFydEFuaW1hdGlvbigpO1xyXG4gIH1cclxuXHJcbiAgcmVzZXRCdXNpbmVzcygpIHtcclxuICAgIHRoaXMuYWN0aW5nID0gZmFsc2U7XHJcbiAgICB0aGlzLnRyYW5zZm9ybWluZyA9IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgaXNCdXN5KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuYWN0aW5nIHx8IHRoaXMudHJhbnNmb3JtaW5nO1xyXG4gIH1cclxufSJdfQ==