"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var checkbox_1 = require("./checkbox");
var _ = require("lodash");
var HabbajetBinding = /** @class */ (function () {
    function HabbajetBinding(budget, saveObject, index, name, isNew, frames, value) {
        this.budget = budget;
        this.saveObject = saveObject;
        this.index = index;
        this.name = name;
        this.frames = frames;
        this.value = value;
        this.checkboxes = [
            new checkbox_1.CheckboxBinding("Sunday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Monday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Tuesday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Wednesday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Thursday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Friday", saveObject, index, isNew),
            new checkbox_1.CheckboxBinding("Saturday", saveObject, index, isNew)
        ];
        this.acting = false;
        this.transforming = false;
        this.action = 'i';
        this.frame = 0;
        if (isNew) {
            this.state = 0;
            this.saveData();
        }
        else {
            this.value = saveObject.getString("h" + this.index + "value");
            this.name = saveObject.getString("h" + this.index + "name");
            this.state = saveObject.getNumber("h" + this.index + "stateIndex");
        }
        this.setActiveDay();
        this.setState(this.state);
    }
    HabbajetBinding.prototype.dailyUpdate = function (success) {
        if (!this.isBusy()) {
            this.activeDay.fillCheckbox(success);
            this.checkboxStateUpdate();
            this.saveData();
        }
    };
    HabbajetBinding.prototype.checkboxStateUpdate = function () {
        var newState = 0;
        var numSetBoxes = 0;
        _.forEach(this.checkboxes, function (c) {
            if (c.isChecked()) {
                newState++;
            }
            if (c.isSet()) {
                numSetBoxes++;
            }
        });
        if (numSetBoxes > 6) {
            this.endWeek(newState);
        }
        else {
            this.setState(newState);
        }
        this.setActiveDay();
    };
    HabbajetBinding.prototype.setImage = function () {
        this.image = "~/images/h" + this.state + "/" + this.action + this.frame + ".png";
        // console.log("image changed to: " + this.image);
    };
    HabbajetBinding.prototype.animate = function () {
        if (this.frames.exists(this.state, this.frame, this.action)) {
            this.setImage();
        }
        else {
            this.makeIdle();
        }
        this.frame++;
    };
    HabbajetBinding.prototype.makeIdle = function () {
        this.resetBusiness();
        this.action = 'i';
        this.restartAnimation();
    };
    HabbajetBinding.prototype.restartAnimation = function () {
        var _this = this;
        clearInterval(this.animationID);
        this.frame = 0;
        this.animationID = setInterval(function () {
            _this.animate();
        }, 100);
    };
    HabbajetBinding.prototype.setState = function (newState) {
        var oldState = this.state;
        this.state = newState;
        if (newState !== oldState) {
            this.transform();
        }
        else {
            this.makeIdle();
        }
    };
    HabbajetBinding.prototype.endWeek = function (successes) {
        this.budget.updateTotal(successes, this.value);
        _.forEach(this.checkboxes, function (c) {
            c.reset();
        });
        this.setState(0);
    };
    HabbajetBinding.prototype.setActiveDay = function () {
        for (var i = 0; i < this.checkboxes.length; i++) {
            if (!this.checkboxes[i].isSet()) {
                this.activeDay = this.checkboxes[i];
                return;
            }
        }
    };
    HabbajetBinding.prototype.saveData = function () {
        this.saveObject.setString("h" + this.index + "value", this.value);
        this.saveObject.setString("h" + this.index + "name", this.name);
        this.saveObject.setNumber("h" + this.index + "stateIndex", this.state);
    };
    HabbajetBinding.prototype.transform = function () {
        this.transforming = true;
        this.action = 't';
        this.restartAnimation();
    };
    HabbajetBinding.prototype.act = function () {
        if (this.isBusy()) {
            return;
        }
        this.transforming = false;
        var actionType = Math.random() * 2;
        if (actionType < 1 && this.frames.exists(this.state, 0, 'a')) {
            this.action = 'a';
        }
        else if (this.frames.exists(this.state, 0, 'b')) {
            this.action = 'b';
        }
        this.restartAnimation();
    };
    HabbajetBinding.prototype.resetBusiness = function () {
        this.acting = false;
        this.transforming = false;
    };
    HabbajetBinding.prototype.isBusy = function () {
        return this.acting || this.transforming;
    };
    HabbajetBinding.prototype.update = function (newName, newValue) {
        this.name = newName;
        this.value = newValue;
    };
    HabbajetBinding.prototype.updateIndex = function (newIndex) {
        this.deleteData();
        this.index = newIndex;
        this.saveData();
    };
    HabbajetBinding.prototype.deleteData = function () {
        this.saveObject.remove("h" + this.index + "value");
        this.saveObject.remove("h" + this.index + "name");
        this.saveObject.remove("h" + this.index + "stateIndex");
    };
    return HabbajetBinding;
}());
exports.HabbajetBinding = HabbajetBinding;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGFiYmFqZXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJoYWJiYWpldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUE2QztBQUM3QywwQkFBNEI7QUFLNUI7SUFhRSx5QkFBb0IsTUFBcUIsRUFBVSxVQUFlLEVBQ3RELEtBQWEsRUFBUyxJQUFZLEVBQUUsS0FBYyxFQUNsRCxNQUFtQixFQUFTLEtBQWE7UUFGakMsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUFVLGVBQVUsR0FBVixVQUFVLENBQUs7UUFDdEQsVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUFTLFNBQUksR0FBSixJQUFJLENBQVE7UUFDbEMsV0FBTSxHQUFOLE1BQU0sQ0FBYTtRQUFTLFVBQUssR0FBTCxLQUFLLENBQVE7UUFFbkQsSUFBSSxDQUFDLFVBQVUsR0FBRztZQUNoQixJQUFJLDBCQUFlLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDO1lBQ3ZELElBQUksMEJBQWUsQ0FBQyxRQUFRLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUM7WUFDdkQsSUFBSSwwQkFBZSxDQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQztZQUN4RCxJQUFJLDBCQUFlLENBQUMsV0FBVyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDO1lBQzFELElBQUksMEJBQWUsQ0FBQyxVQUFVLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUM7WUFDekQsSUFBSSwwQkFBZSxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQztZQUN2RCxJQUFJLDBCQUFlLENBQUMsVUFBVSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDO1NBQzFELENBQUM7UUFDRixJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUUsWUFBWSxHQUFHLEtB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SUFBSSxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxZQUFZLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBQ0gsc0JBQUM7QUFBRCxDQUFDLEFBaExELElBZ0xDO0FBaExZLDBDQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hlY2tib3hCaW5kaW5nIH0gZnJvbSBcIi4vY2hlY2tib3hcIjtcclxuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xyXG5pbXBvcnQgKiBhcyBEaWFsb2dzIGZyb20gJ3VpL2RpYWxvZ3MnO1xyXG5pbXBvcnQgeyBCdWRnZXRCaW5kaW5nIH0gZnJvbSBcIi4vYnVkZ2V0XCI7XHJcbmltcG9ydCB7IEZyYW1lQ291bnRzIH0gZnJvbSBcIi4vZnJhbWUtY291bnRzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgSGFiYmFqZXRCaW5kaW5nIHtcclxuICBwcml2YXRlIHN0YXRlOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBmcmFtZTogbnVtYmVyO1xyXG4gIHByaXZhdGUgYWN0aW9uOiBzdHJpbmc7XHJcbiAgcHVibGljIGltYWdlOiBzdHJpbmc7XHJcbiAgcHVibGljIGNoZWNrYm94ZXM6IENoZWNrYm94QmluZGluZ1tdO1xyXG4gIHB1YmxpYyBhY3RpdmVEYXk6IENoZWNrYm94QmluZGluZztcclxuICBwdWJsaWMgYW5pbWF0aW5nOiBib29sZWFuO1xyXG4gIHB1YmxpYyBhbmltYXRpb25JRDogbnVtYmVyO1xyXG5cclxuICBwdWJsaWMgdHJhbnNmb3JtaW5nOiBib29sZWFuO1xyXG4gIHByaXZhdGUgYWN0aW5nOiBib29sZWFuO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGJ1ZGdldDogQnVkZ2V0QmluZGluZywgcHJpdmF0ZSBzYXZlT2JqZWN0OiBhbnksXHJcbiAgICAgIHByaXZhdGUgaW5kZXg6IG51bWJlciwgcHVibGljIG5hbWU6IHN0cmluZywgaXNOZXc6IGJvb2xlYW4sXHJcbiAgICAgIHByaXZhdGUgZnJhbWVzOiBGcmFtZUNvdW50cywgcHVibGljIHZhbHVlOiBzdHJpbmcpIHtcclxuICAgIFxyXG4gICAgdGhpcy5jaGVja2JveGVzID0gW1xyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKFwiU3VuZGF5XCIsIHNhdmVPYmplY3QsIGluZGV4LCBpc05ldyksXHJcbiAgICAgIG5ldyBDaGVja2JveEJpbmRpbmcoXCJNb25kYXlcIiwgc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3KSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhcIlR1ZXNkYXlcIiwgc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3KSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhcIldlZG5lc2RheVwiLCBzYXZlT2JqZWN0LCBpbmRleCwgaXNOZXcpLFxyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKFwiVGh1cnNkYXlcIiwgc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3KSxcclxuICAgICAgbmV3IENoZWNrYm94QmluZGluZyhcIkZyaWRheVwiLCBzYXZlT2JqZWN0LCBpbmRleCwgaXNOZXcpLFxyXG4gICAgICBuZXcgQ2hlY2tib3hCaW5kaW5nKFwiU2F0dXJkYXlcIiwgc2F2ZU9iamVjdCwgaW5kZXgsIGlzTmV3KVxyXG4gICAgXTtcclxuICAgIHRoaXMuYWN0aW5nID0gZmFsc2U7XHJcbiAgICB0aGlzLiB0cmFuc2Zvcm1pbmcgPSBmYWxzZTtcclxuICAgIHRoaXMuYWN0aW9uID0gJ2knO1xyXG4gICAgdGhpcy5mcmFtZSA9IDA7XHJcbiAgICBpZihpc05ldykge1xyXG4gICAgICB0aGlzLnN0YXRlID0gMDtcclxuICAgICAgdGhpcy5zYXZlRGF0YSgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy52YWx1ZSA9IHNhdmVPYmplY3QuZ2V0U3RyaW5nKFwiaFwiICsgdGhpcy5pbmRleCArIFwidmFsdWVcIilcclxuICAgICAgdGhpcy5uYW1lID0gc2F2ZU9iamVjdC5nZXRTdHJpbmcoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJuYW1lXCIpO1xyXG4gICAgICB0aGlzLnN0YXRlID0gc2F2ZU9iamVjdC5nZXROdW1iZXIoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJzdGF0ZUluZGV4XCIpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zZXRBY3RpdmVEYXkoKTtcclxuICAgIHRoaXMuc2V0U3RhdGUodGhpcy5zdGF0ZSk7XHJcbiAgfVxyXG5cclxuICBkYWlseVVwZGF0ZShzdWNjZXNzOiBib29sZWFuKSB7XHJcbiAgICBpZighdGhpcy5pc0J1c3koKSkge1xyXG4gICAgICB0aGlzLmFjdGl2ZURheS5maWxsQ2hlY2tib3goc3VjY2Vzcyk7XHJcbiAgICAgIHRoaXMuY2hlY2tib3hTdGF0ZVVwZGF0ZSgpO1xyXG4gICAgICB0aGlzLnNhdmVEYXRhKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjaGVja2JveFN0YXRlVXBkYXRlKCkge1xyXG4gICAgbGV0IG5ld1N0YXRlID0gMDtcclxuICAgIGxldCBudW1TZXRCb3hlcyA9IDA7XHJcbiAgICBfLmZvckVhY2godGhpcy5jaGVja2JveGVzLCAoYykgPT4ge1xyXG4gICAgICBpZihjLmlzQ2hlY2tlZCgpKSB7XHJcbiAgICAgICAgbmV3U3RhdGUrKztcclxuICAgICAgfVxyXG4gICAgICBpZihjLmlzU2V0KCkpIHtcclxuICAgICAgICBudW1TZXRCb3hlcysrO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZihudW1TZXRCb3hlcyA+IDYpIHtcclxuICAgICAgdGhpcy5lbmRXZWVrKG5ld1N0YXRlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuc2V0U3RhdGUobmV3U3RhdGUpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zZXRBY3RpdmVEYXkoKTtcclxuICB9XHJcblxyXG4gIHNldEltYWdlKCkge1xyXG4gICAgdGhpcy5pbWFnZSA9IFwifi9pbWFnZXMvaFwiICsgdGhpcy5zdGF0ZSArIFwiL1wiICsgdGhpcy5hY3Rpb24gKyB0aGlzLmZyYW1lICsgXCIucG5nXCI7XHJcbiAgICAvLyBjb25zb2xlLmxvZyhcImltYWdlIGNoYW5nZWQgdG86IFwiICsgdGhpcy5pbWFnZSk7XHJcbiAgfVxyXG5cclxuICBhbmltYXRlKCkge1xyXG4gICAgICBpZih0aGlzLmZyYW1lcy5leGlzdHModGhpcy5zdGF0ZSwgdGhpcy5mcmFtZSwgdGhpcy5hY3Rpb24pKSB7XHJcbiAgICAgICAgdGhpcy5zZXRJbWFnZSgpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMubWFrZUlkbGUoKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmZyYW1lKys7XHJcbiAgfVxyXG5cclxuICBtYWtlSWRsZSgpIHtcclxuICAgIHRoaXMucmVzZXRCdXNpbmVzcygpO1xyXG4gICAgdGhpcy5hY3Rpb24gPSAnaSc7XHJcbiAgICB0aGlzLnJlc3RhcnRBbmltYXRpb24oKTtcclxuICB9XHJcblxyXG4gIHJlc3RhcnRBbmltYXRpb24oKSB7XHJcbiAgICBjbGVhckludGVydmFsKHRoaXMuYW5pbWF0aW9uSUQpO1xyXG4gICAgdGhpcy5mcmFtZSA9IDA7XHJcbiAgICB0aGlzLmFuaW1hdGlvbklEID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICB0aGlzLmFuaW1hdGUoKTtcclxuICAgIH0sIDEwMCk7XHJcbiAgfVxyXG5cclxuICBzZXRTdGF0ZShuZXdTdGF0ZTogbnVtYmVyKSB7XHJcbiAgICBjb25zdCBvbGRTdGF0ZSA9IHRoaXMuc3RhdGU7XHJcbiAgICB0aGlzLnN0YXRlID0gbmV3U3RhdGU7XHJcbiAgICBpZihuZXdTdGF0ZSAhPT0gb2xkU3RhdGUpIHtcclxuICAgICAgdGhpcy50cmFuc2Zvcm0oKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMubWFrZUlkbGUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGVuZFdlZWsoc3VjY2Vzc2VzOiBudW1iZXIpIHtcclxuICAgIHRoaXMuYnVkZ2V0LnVwZGF0ZVRvdGFsKHN1Y2Nlc3NlcywgdGhpcy52YWx1ZSk7XHJcbiAgICBfLmZvckVhY2godGhpcy5jaGVja2JveGVzLCAoYykgPT4ge1xyXG4gICAgICBjLnJlc2V0KCk7XHJcbiAgICB9KTtcclxuICAgIHRoaXMuc2V0U3RhdGUoMCk7XHJcbiAgfVxyXG5cclxuICBzZXRBY3RpdmVEYXkoKSB7XHJcbiAgICBmb3IobGV0IGkgPSAwOyBpIDwgdGhpcy5jaGVja2JveGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGlmICghdGhpcy5jaGVja2JveGVzW2ldLmlzU2V0KCkpIHtcclxuICAgICAgICB0aGlzLmFjdGl2ZURheSA9IHRoaXMuY2hlY2tib3hlc1tpXTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNhdmVEYXRhKCkge1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnNldFN0cmluZyhcImhcIiArIHRoaXMuaW5kZXggKyBcInZhbHVlXCIsIHRoaXMudmFsdWUpO1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnNldFN0cmluZyhcImhcIiArIHRoaXMuaW5kZXggKyBcIm5hbWVcIiwgdGhpcy5uYW1lKTtcclxuICAgIHRoaXMuc2F2ZU9iamVjdC5zZXROdW1iZXIoXCJoXCIgKyB0aGlzLmluZGV4ICsgXCJzdGF0ZUluZGV4XCIsIHRoaXMuc3RhdGUpO1xyXG4gIH1cclxuXHJcbiAgdHJhbnNmb3JtKCkge1xyXG4gICAgdGhpcy50cmFuc2Zvcm1pbmcgPSB0cnVlO1xyXG4gICAgdGhpcy5hY3Rpb24gPSAndCc7XHJcbiAgICB0aGlzLnJlc3RhcnRBbmltYXRpb24oKTtcclxuICB9XHJcblxyXG4gIGFjdCgpIHtcclxuICAgIGlmICh0aGlzLmlzQnVzeSgpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMudHJhbnNmb3JtaW5nID0gZmFsc2U7XHJcbiAgICBjb25zdCBhY3Rpb25UeXBlID0gTWF0aC5yYW5kb20oKSAqIDJcclxuICAgIGlmKGFjdGlvblR5cGUgPCAxICYmIHRoaXMuZnJhbWVzLmV4aXN0cyh0aGlzLnN0YXRlLCAwLCAnYScpKSB7XHJcbiAgICAgIHRoaXMuYWN0aW9uID0gJ2EnO1xyXG4gICAgfSBlbHNlIGlmKHRoaXMuZnJhbWVzLmV4aXN0cyh0aGlzLnN0YXRlLCAwLCAnYicpKSB7XHJcbiAgICAgIHRoaXMuYWN0aW9uID0gJ2InO1xyXG4gICAgfVxyXG4gICAgdGhpcy5yZXN0YXJ0QW5pbWF0aW9uKCk7XHJcbiAgfVxyXG5cclxuICByZXNldEJ1c2luZXNzKCkge1xyXG4gICAgdGhpcy5hY3RpbmcgPSBmYWxzZTtcclxuICAgIHRoaXMudHJhbnNmb3JtaW5nID0gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBpc0J1c3koKSB7XHJcbiAgICByZXR1cm4gdGhpcy5hY3RpbmcgfHwgdGhpcy50cmFuc2Zvcm1pbmc7XHJcbiAgfVxyXG5cclxuICB1cGRhdGUobmV3TmFtZTogc3RyaW5nLCBuZXdWYWx1ZTogc3RyaW5nKSB7XHJcbiAgICB0aGlzLm5hbWUgPSBuZXdOYW1lO1xyXG4gICAgdGhpcy52YWx1ZSA9IG5ld1ZhbHVlO1xyXG4gIH1cclxuXHJcbiAgdXBkYXRlSW5kZXgobmV3SW5kZXg6IG51bWJlcikge1xyXG4gICAgdGhpcy5kZWxldGVEYXRhKCk7XHJcbiAgICB0aGlzLmluZGV4ID0gbmV3SW5kZXg7XHJcbiAgICB0aGlzLnNhdmVEYXRhKCk7XHJcbiAgfVxyXG5cclxuICBkZWxldGVEYXRhKCkge1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnJlbW92ZShcImhcIiArIHRoaXMuaW5kZXggKyBcInZhbHVlXCIpO1xyXG4gICAgdGhpcy5zYXZlT2JqZWN0LnJlbW92ZShcImhcIiArIHRoaXMuaW5kZXggKyBcIm5hbWVcIik7XHJcbiAgICB0aGlzLnNhdmVPYmplY3QucmVtb3ZlKFwiaFwiICsgdGhpcy5pbmRleCArIFwic3RhdGVJbmRleFwiKTtcclxuICB9XHJcbn0iXX0=